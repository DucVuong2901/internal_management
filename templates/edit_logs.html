{% extends "base.html" %}

{% block title %}Lịch sử Chỉnh sửa - Hệ thống Quản lý Nội bộ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-clock-history"></i> Lịch sử Chỉnh sửa</h1>
        <p class="text-muted">Xem lại các thay đổi đã được thực hiện trong hệ thống</p>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-list"></i> Ghi nhận thay đổi</h5>
    </div>
    <div class="card-body">
        {% if logs %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Thời gian</th>
                        <th>Loại</th>
                        <th>ID</th>
                        <th>Hành động</th>
                        <th>Người thực hiện</th>
                        <th>Thay đổi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            {% if log.get('created_at') and log.created_at %}
                                {{ log.created_at.strftime('%d/%m/%Y %H:%M:%S') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if log.get('item_type') == 'note' %}
                            <span class="badge bg-info">Ghi chú</span>
                            {% elif log.get('item_type') == 'doc' %}
                            <span class="badge bg-success">Tài liệu</span>
                            {% elif log.get('item_type') == 'user' %}
                            <span class="badge bg-warning">Người dùng</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ log.get('item_type', 'N/A') }}</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ log.get('item_id', 'N/A') }}</strong></td>
                        <td>
                            {% if log.get('action') == 'edit' %}
                            <span class="badge bg-primary">Chỉnh sửa</span>
                            {% elif log.get('action') == 'create' %}
                            <span class="badge bg-success">Tạo mới</span>
                            {% elif log.get('action') == 'delete' %}
                            <span class="badge bg-danger">Xóa</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ log.get('action', 'N/A') }}</span>
                            {% endif %}
                        </td>
                        <td>{{ log.get('username', 'Unknown') }}</td>
                        <td>
                            {% if log.get('changes') %}
                            <button class="btn btn-sm btn-outline-info show-changes-btn" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#changes-{{ log.id }}"
                                    data-log-id="{{ log.id }}">
                                <i class="bi bi-eye"></i> Chi tiết
                            </button>
                            <div class="collapse mt-2" id="changes-{{ log.id }}">
                                <div class="card card-body bg-light" style="max-width: 100%; overflow-x: auto;">
                                    {% set changes = log.changes %}
                                    
                                    {% if changes.get('action') %}
                                        <strong>{{ changes.action }}</strong>
                                    {% elif changes.get('title') %}
                                        {# Xử lý title - có thể là string hoặc dict #}
                                        {% if changes.title is mapping and changes.title.get('old') and changes.title.get('new') %}
                                        <div class="mb-3 title-diff-container">
                                            <strong>Tiêu đề:</strong>
                                            <div class="mt-2">
                                                <div class="change-item-old mb-2 p-2 rounded" style="background-color: #fee; border-left: 3px solid #dc3545;">
                                                    <small class="text-muted d-block mb-1"><i class="bi bi-dash-circle"></i> Trước:</small>
                                                    <div class="change-content-old diff-old-title" 
                                                         data-old-text="{{ changes.title.old | striptags | trim | e }}">{{ changes.title.old | striptags | trim }}</div>
                                                </div>
                                                <div class="change-item-new p-2 rounded" style="background-color: #efe; border-left: 3px solid #28a745;">
                                                    <small class="text-muted d-block mb-1"><i class="bi bi-plus-circle"></i> Sau:</small>
                                                    <div class="change-content-new diff-new-title"
                                                         data-new-text="{{ changes.title.new | striptags | trim | e }}">{{ changes.title.new | striptags | trim }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        {% elif changes.title %}
                                        <div class="mb-2"><strong>Tiêu đề:</strong> 
                                            <span class="p-2 rounded d-inline-block" style="background-color: #f8f9fa;">
                                                {{ changes.title | striptags | trim }}
                                            </span>
                                        </div>
                                        {% endif %}
                                        
                                        {# Xử lý content - có thể là string hoặc dict #}
                                        {% if changes.get('content') %}
                                            {% if changes.content is mapping and changes.content.get('old') %}
                                            <div class="mb-3 content-diff-container" data-log-id="{{ log.id }}">
                                                <strong>Nội dung:</strong>
                                                <div class="mt-2">
                                                    <div class="change-item-old mb-2 p-2 rounded" style="background-color: #fee; border-left: 3px solid #dc3545;">
                                                        <small class="text-muted d-block mb-1"><i class="bi bi-dash-circle"></i> Trước:</small>
                                                        <div class="change-content-old diff-old" 
                                                             data-old-text="{{ changes.content.old | striptags | replace('<br>', '\n') | replace('<br/>', '\n') | replace('&nbsp;', ' ') | trim | e }}"
                                                             style="white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto; line-height: 1.8;">
                                                            {{ changes.content.old | striptags | replace('<br>', '\n') | replace('<br/>', '\n') | replace('&nbsp;', ' ') | trim }}
                                                        </div>
                                                    </div>
                                                    <div class="change-item-new p-2 rounded" style="background-color: #efe; border-left: 3px solid #28a745;">
                                                        <small class="text-muted d-block mb-1"><i class="bi bi-plus-circle"></i> Sau:</small>
                                                        <div class="change-content-new diff-new"
                                                             data-new-text="{{ changes.content.new | striptags | replace('<br>', '\n') | replace('<br/>', '\n') | replace('&nbsp;', ' ') | trim | e }}"
                                                             style="white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto; line-height: 1.8;">
                                                            {{ changes.content.new | striptags | replace('<br>', '\n') | replace('<br/>', '\n') | replace('&nbsp;', ' ') | trim }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <div class="mb-2"><strong>Nội dung:</strong> 
                                                <div class="mt-1 p-2 rounded" style="background-color: #f8f9fa; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto;">
                                                    {{ changes.content | striptags | replace('<br>', '\n') | replace('<br/>', '\n') | replace('&nbsp;', ' ') | trim }}
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Xử lý category - có thể là string hoặc dict #}
                                        {% if changes.get('category') %}
                                            {% if changes.category is mapping and changes.category.get('old') %}
                                            <div class="mb-3">
                                                <strong>Danh mục:</strong>
                                                <div class="mt-2">
                                                    <div class="change-item-old mb-2 p-2 rounded d-inline-block" style="background-color: #fee; border-left: 3px solid #dc3545;">
                                                        <small class="text-muted d-block mb-1"><i class="bi bi-dash-circle"></i> Trước:</small>
                                                        <span class="badge bg-secondary">{{ changes.category.old }}</span>
                                                    </div>
                                                    <div class="change-item-new p-2 rounded d-inline-block" style="background-color: #efe; border-left: 3px solid #28a745;">
                                                        <small class="text-muted d-block mb-1"><i class="bi bi-plus-circle"></i> Sau:</small>
                                                        <span class="badge bg-primary">{{ changes.category.new }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <div class="mb-2"><strong>Danh mục:</strong> 
                                                <span class="badge bg-secondary">{{ changes.category }}</span>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                        
                                        {# Các field khác #}
                                        {% if changes.get('username') %}
                                        <div class="mb-2"><strong>Người dùng:</strong> {{ changes.username }}</div>
                                        {% endif %}
                                        
                                        {% if changes.get('role') %}
                                            {% if changes.role is mapping and changes.role.get('old') %}
                                            <div class="mb-3">
                                                <strong>Quyền:</strong>
                                                <div class="mt-2">
                                                    <div class="change-item-old mb-2 p-2 rounded d-inline-block" style="background-color: #fee; border-left: 3px solid #dc3545;">
                                                        <small class="text-muted d-block mb-1"><i class="bi bi-dash-circle"></i> Trước:</small>
                                                        <span class="badge bg-secondary">{{ changes.role.old }}</span>
                                                    </div>
                                                    <div class="change-item-new p-2 rounded d-inline-block" style="background-color: #efe; border-left: 3px solid #28a745;">
                                                        <small class="text-muted d-block mb-1"><i class="bi bi-plus-circle"></i> Sau:</small>
                                                        <span class="badge bg-warning">{{ changes.role.new }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <div class="mb-2"><strong>Quyền:</strong> 
                                                <span class="badge bg-warning">{{ changes.role }}</span>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if changes.get('password') %}
                                        <div class="mb-2"><strong>Mật khẩu:</strong> {{ changes.password }}</div>
                                        {% endif %}
                                        
                                        {% if changes.get('is_active') %}
                                            {% if changes.is_active is mapping and changes.is_active.get('old') is not none %}
                                            <div class="mb-3">
                                                <strong>Trạng thái:</strong>
                                                <div class="mt-2">
                                                    <div class="change-item-old mb-2 p-2 rounded d-inline-block" style="background-color: #fee; border-left: 3px solid #dc3545;">
                                                        <small class="text-muted d-block mb-1"><i class="bi bi-dash-circle"></i> Trước:</small>
                                                        <span class="badge {% if changes.is_active.old %}bg-success{% else %}bg-secondary{% endif %}">
                                                            {{ 'Hoạt động' if changes.is_active.old else 'Không hoạt động' }}
                                                        </span>
                                                    </div>
                                                    <div class="change-item-new p-2 rounded d-inline-block" style="background-color: #efe; border-left: 3px solid #28a745;">
                                                        <small class="text-muted d-block mb-1"><i class="bi bi-plus-circle"></i> Sau:</small>
                                                        <span class="badge {% if changes.is_active.new %}bg-success{% else %}bg-secondary{% endif %}">
                                                            {{ 'Hoạt động' if changes.is_active.new else 'Không hoạt động' }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% else %}
                                            <div class="mb-2"><strong>Trạng thái:</strong> 
                                                <span class="badge {% if changes.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                                    {{ 'Hoạt động' if changes.is_active else 'Không hoạt động' }}
                                                </span>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        <pre class="mb-0">{{ changes | tojson(indent=2) }}</pre>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> Chưa có ghi nhận thay đổi nào.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.diff-highlight-removed {
    background-color: #ffcccc !important;
    text-decoration: line-through;
    padding: 2px 4px;
    border-radius: 3px;
}

.diff-highlight-added {
    background-color: #ccffcc !important;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 500;
}

.diff-highlight-changed {
    background-color: #ffff99 !important;
    padding: 2px 4px;
    border-radius: 3px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Diff algorithm đơn giản để highlight sự khác biệt
function createDiff(oldText, newText) {
    // Chia thành các từ và ký tự
    function tokenize(text) {
        // Giữ lại khoảng trắng và xuống dòng
        return text.split(/(\s+)/).filter(t => t.length > 0);
    }
    
    const oldTokens = tokenize(oldText);
    const newTokens = tokenize(newText);
    
    // Tìm longest common subsequence
    const matrix = [];
    for (let i = 0; i <= oldTokens.length; i++) {
        matrix[i] = [];
        for (let j = 0; j <= newTokens.length; j++) {
            if (i === 0 || j === 0) {
                matrix[i][j] = 0;
            } else if (oldTokens[i-1] === newTokens[j-1]) {
                matrix[i][j] = matrix[i-1][j-1] + 1;
            } else {
                matrix[i][j] = Math.max(matrix[i-1][j], matrix[i][j-1]);
            }
        }
    }
    
    // Tạo diff
    let i = oldTokens.length;
    let j = newTokens.length;
    const oldResult = [];
    const newResult = [];
    
    while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && oldTokens[i-1] === newTokens[j-1]) {
            oldResult.unshift({type: 'common', text: oldTokens[i-1]});
            newResult.unshift({type: 'common', text: newTokens[j-1]});
            i--;
            j--;
        } else if (j > 0 && (i === 0 || matrix[i][j-1] >= matrix[i-1][j])) {
            newResult.unshift({type: 'added', text: newTokens[j-1]});
            j--;
        } else {
            oldResult.unshift({type: 'removed', text: oldTokens[i-1]});
            i--;
        }
    }
    
    return {old: oldResult, new: newResult};
}

// Render diff với highlight
function renderDiff(container, oldText, newText) {
    const diff = createDiff(oldText, newText);
    
    const oldDiv = container.querySelector('.diff-old');
    const newDiv = container.querySelector('.diff-new');
    
    if (oldDiv) {
        oldDiv.innerHTML = diff.old.map(item => {
            if (item.type === 'removed') {
                return `<span class="diff-highlight-removed">${escapeHtml(item.text)}</span>`;
            }
            return escapeHtml(item.text);
        }).join('');
    }
    
    if (newDiv) {
        newDiv.innerHTML = diff.new.map(item => {
            if (item.type === 'added') {
                return `<span class="diff-highlight-added">${escapeHtml(item.text)}</span>`;
            }
            return escapeHtml(item.text);
        }).join('');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Xử lý khi click vào button chi tiết
document.addEventListener('DOMContentLoaded', function() {
    // Lắng nghe khi collapse được mở
    document.querySelectorAll('.show-changes-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const logId = this.getAttribute('data-log-id');
            const targetId = this.getAttribute('data-bs-target');
            const target = document.querySelector(targetId);
            
            if (target) {
                // Đợi collapse mở xong
                setTimeout(function() {
                    // Render diff cho content
                    const contentContainer = target.querySelector('.content-diff-container');
                    if (contentContainer) {
                        const oldDiv = contentContainer.querySelector('.diff-old');
                        const newDiv = contentContainer.querySelector('.diff-new');
                        if (oldDiv && newDiv) {
                            const oldText = oldDiv.getAttribute('data-old-text') || oldDiv.textContent;
                            const newText = newDiv.getAttribute('data-new-text') || newDiv.textContent;
                            if (oldText !== newText) {
                                renderDiff(contentContainer, oldText, newText);
                                
                                // Scroll đến phần được highlight đầu tiên
                                setTimeout(function() {
                                    const firstHighlight = contentContainer.querySelector('.diff-highlight-removed, .diff-highlight-added');
                                    if (firstHighlight) {
                                        firstHighlight.scrollIntoView({behavior: 'smooth', block: 'center'});
                                        // Highlight flash effect
                                        firstHighlight.style.transition = 'box-shadow 0.3s';
                                        firstHighlight.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.8)';
                                        setTimeout(function() {
                                            firstHighlight.style.boxShadow = '';
                                        }, 1000);
                                    }
                                }, 100);
                            }
                        }
                    }
                    
                    // Render diff cho title
                    const titleContainer = target.querySelector('.title-diff-container');
                    if (titleContainer) {
                        const oldDiv = titleContainer.querySelector('.diff-old-title');
                        const newDiv = titleContainer.querySelector('.diff-new-title');
                        if (oldDiv && newDiv) {
                            const oldText = oldDiv.getAttribute('data-old-text') || oldDiv.textContent;
                            const newText = newDiv.getAttribute('data-new-text') || newDiv.textContent;
                            if (oldText !== newText) {
                                renderDiff(titleContainer, oldText, newText);
                            }
                        }
                    }
                }, 300);
            }
        });
    });
    
    // Xử lý khi collapse đã mở sẵn (trường hợp refresh trang)
    document.querySelectorAll('.collapse.show').forEach(collapse => {
        const contentContainer = collapse.querySelector('.content-diff-container');
        if (contentContainer) {
            const oldDiv = contentContainer.querySelector('.diff-old');
            const newDiv = contentContainer.querySelector('.diff-new');
            if (oldDiv && newDiv) {
                const oldText = oldDiv.getAttribute('data-old-text') || oldDiv.textContent;
                const newText = newDiv.getAttribute('data-new-text') || newDiv.textContent;
                if (oldText !== newText) {
                    renderDiff(contentContainer, oldText, newText);
                }
            }
        }
        
        const titleContainer = collapse.querySelector('.title-diff-container');
        if (titleContainer) {
            const oldDiv = titleContainer.querySelector('.diff-old-title');
            const newDiv = titleContainer.querySelector('.diff-new-title');
            if (oldDiv && newDiv) {
                const oldText = oldDiv.getAttribute('data-old-text') || oldDiv.textContent;
                const newText = newDiv.getAttribute('data-new-text') || newDiv.textContent;
                if (oldText !== newText) {
                    renderDiff(titleContainer, oldText, newText);
                }
            }
        }
    });
});
</script>
{% endblock %}

