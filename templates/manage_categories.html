{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω Danh m·ª•c - H·ªá th·ªëng Qu·∫£n l√Ω N·ªôi b·ªô{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-tags"></i> Qu·∫£n l√Ω Danh m·ª•c</h1>
        <p class="text-muted">T·∫°o v√† qu·∫£n l√Ω c√°c danh m·ª•c ƒë·ªÉ ph√¢n lo·∫°i ghi ch√∫ v√† t√†i li·ªáu</p>
    </div>
</div>

<div class="row">
    <!-- Th√™m danh m·ª•c m·ªõi -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Th√™m danh m·ª•c m·ªõi</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('add_category') }}">
                    <div class="mb-3">
                        <label for="category" class="form-label">T√™n danh m·ª•c</label>
                        <input type="text" class="form-control" id="category" name="category" 
                               placeholder="v√≠ d·ª•: c√¥ng vi·ªác, c√° nh√¢n, h·ªçc t·∫≠p..." required>
                        <small class="form-text text-muted">
                            T√™n danh m·ª•c s·∫Ω ƒë∆∞·ª£c chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng t·ª± ƒë·ªông.<br>
                            <strong class="text-info">üí° L∆∞u √Ω:</strong> C√≥ th·ªÉ t·∫°o danh m·ª•c con c√πng t√™n nh∆∞ng kh√°c danh m·ª•c cha (v√≠ d·ª•: "hr" trong "mail" v√† "hr" trong "c√¥ng vi·ªác")
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="parent" class="form-label">Danh m·ª•c cha (t√πy ch·ªçn)</label>
                        <select class="form-select" id="parent" name="parent">
                            <option value="">-- Kh√¥ng c√≥ (danh m·ª•c g·ªëc) --</option>
                            {% for cat_name, cat_data in categories.items() %}
                                {% if not cat_data.parent %}
                                    {# Danh m·ª•c g·ªëc #}
                                    <option value="{{ cat_name }}">üìÅ {{ cat_name }}</option>
                                    {# Danh m·ª•c con c·ªßa danh m·ª•c n√†y #}
                                    {% if cat_data.children %}
                                        {% for child_name in cat_data.children %}
                                            <option value="{{ child_name }}">&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ {{ child_name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Ch·ªçn danh m·ª•c cha ƒë·ªÉ t·∫°o danh m·ª•c con</small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Th√™m danh m·ª•c
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Danh s√°ch danh m·ª•c -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list"></i> Danh s√°ch danh m·ª•c</h5>
                <form method="post" action="{{ url_for('fix_orphan_categories') }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-warning" title="S·ª≠a c√°c danh m·ª•c con b·ªã l·ªói hi·ªÉn th·ªã">
                        <i class="bi bi-wrench"></i> S·ª≠a l·ªói hi·ªÉn th·ªã
                    </button>
                </form>
            </div>
            <div class="card-body">
                {% if categories %}
                <div class="list-group">
                    {% for cat_name, cat_data in categories.items() %}
                        {% if not cat_data.parent %}
                        <!-- Danh m·ª•c g·ªëc -->
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="flex-grow-1" style="cursor: pointer;" onclick="toggleChildren('{{ cat_name }}')">
                                    {% if cat_data.children %}
                                    <i class="bi bi-chevron-right toggle-icon" id="icon-{{ cat_name }}"></i>
                                    {% else %}
                                    <i class="bi bi-folder"></i>
                                    {% endif %}
                                    <strong>{{ cat_data.get('display_name', cat_data.get('name', cat_name)) }}</strong>
                                    {% if cat_name == 'general' %}
                                    <span class="badge bg-info ms-2">M·∫∑c ƒë·ªãnh</span>
                                    {% endif %}
                                    {% if cat_data.children %}
                                    <span class="badge bg-secondary ms-2">{{ cat_data.children|length }} danh m·ª•c con</span>
                                    {% endif %}
                                </span>
                                {% if cat_name != 'general' %}
                                <form method="post" action="{{ url_for('delete_category') }}" 
                                      onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c \"{{ cat_name }}\"?');" class="d-inline">
                                    <input type="hidden" name="category" value="{{ cat_name }}">
                                    <button type="submit" class="btn btn-sm btn-danger" {% if cat_data.children %}disabled title="Ph·∫£i x√≥a danh m·ª•c con tr∆∞·ªõc"{% endif %}>
                                        <i class="bi bi-trash"></i> X√≥a
                                    </button>
                                </form>
                                {% else %}
                                <span class="text-muted small">Kh√¥ng th·ªÉ x√≥a</span>
                                {% endif %}
                            </div>
                            
                            <!-- Danh m·ª•c con (·∫©n m·∫∑c ƒë·ªãnh) -->
                            {% if cat_data.children %}
                            <div class="ms-4 mt-2" id="children-{{ cat_name }}" style="display: none;">
                                {% for child_key in cat_data.children %}
                                    {% if child_key in categories %}
                                    {% set child_data = categories[child_key] %}
                                    <div class="d-flex justify-content-between align-items-center py-2 border-top">
                                        <span class="text-muted">
                                            <i class="bi bi-arrow-return-right"></i> 
                                            <i class="bi bi-tag"></i> {{ child_data.get('display_name', child_data.get('name', child_key)) }}
                                        </span>
                                        <form method="post" action="{{ url_for('delete_category') }}" 
                                              onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c con?');" class="d-inline">
                                            <input type="hidden" name="category" value="{{ child_key }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Ch∆∞a c√≥ danh m·ª•c n√†o.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> <strong>L∆∞u √Ω:</strong>
            <ul class="mb-0 mt-2">
                <li>Danh m·ª•c "general" l√† danh m·ª•c m·∫∑c ƒë·ªãnh v√† kh√¥ng th·ªÉ x√≥a</li>
                <li><strong>üí° Danh m·ª•c con c√πng t√™n:</strong> C√≥ th·ªÉ t·∫°o danh m·ª•c con c√πng t√™n nh∆∞ng kh√°c danh m·ª•c cha (v√≠ d·ª•: "hr" trong "mail" v√† "hr" trong "c√¥ng vi·ªác")</li>
                <li><strong>Danh m·ª•c g·ªëc:</strong> T√™n danh m·ª•c g·ªëc ph·∫£i duy nh·∫•t (kh√¥ng ƒë∆∞·ª£c tr√πng v·ªõi danh m·ª•c g·ªëc kh√°c)</li>
                <li><strong>Click v√†o danh m·ª•c cha</strong> (icon ‚ñ∂) ƒë·ªÉ xem/·∫©n danh m·ª•c con b√™n trong</li>
                <li><strong>N·∫øu danh m·ª•c con hi·ªÉn th·ªã sai:</strong> Click n√∫t "S·ª≠a l·ªói hi·ªÉn th·ªã" ·ªü g√≥c ph·∫£i ƒë·ªÉ t·ª± ƒë·ªông s·ª≠a</li>
                <li>Kh√¥ng th·ªÉ x√≥a danh m·ª•c cha n·∫øu c√≤n danh m·ª•c con. Ph·∫£i x√≥a danh m·ª•c con tr∆∞·ªõc</li>
                <li>Khi x√≥a m·ªôt danh m·ª•c, t·∫•t c·∫£ ghi ch√∫ v√† t√†i li·ªáu thu·ªôc danh m·ª•c ƒë√≥ s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông chuy·ªÉn v·ªÅ danh m·ª•c "general"</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleChildren(categoryName) {
    const childrenDiv = document.getElementById('children-' + categoryName);
    const icon = document.getElementById('icon-' + categoryName);
    
    if (childrenDiv) {
        if (childrenDiv.style.display === 'none') {
            // Expand
            childrenDiv.style.display = 'block';
            if (icon) {
                icon.classList.remove('bi-chevron-right');
                icon.classList.add('bi-chevron-down');
            }
        } else {
            // Collapse
            childrenDiv.style.display = 'none';
            if (icon) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-right');
            }
        }
    }
}
</script>
{% endblock %}
