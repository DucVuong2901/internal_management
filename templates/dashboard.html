{% extends "base.html" %}

{% block title %}Dashboard - Note ƒëi m·∫•y c∆∞ng{% endblock %}

{% block content %}
<!-- Notification Dropdown Button - Fixed Top Right -->
<div class="notification-dropdown-trigger">
  <button class="btn btn-dark" id="notificationToggleBtn" onclick="toggleNotificationPanel()">
    <i class="bi bi-bell-fill"></i> Th√¥ng b√°o
    <span class="badge bg-danger ms-2" id="dashboardNotificationCount" style="display:none;">0</span>
  </button>
</div>

<!-- Notification Panel - Dropdown -->
<div class="notification-panel-dropdown" id="notificationPanelDropdown" style="display:none;">
  <div class="notification-header-dashboard">
    <h6><i class="bi bi-bell-fill"></i> Th√¥ng b√°o</h6>
    <button class="btn-close" onclick="toggleNotificationPanel()"></button>
  </div>
  <div class="notification-list-dashboard" id="dashboardNotificationList">
    <div class="notification-empty">
      <i class="bi bi-bell" style="font-size:48px;opacity:0.3"></i>
      <p class="mt-2">Ch∆∞a c√≥ th√¥ng b√°o</p>
    </div>
  </div>
  <div class="notification-actions-dashboard">
    <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="markAllNotificationsReadDashboard()" title="ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc">
      <i class="bi bi-check-all"></i> ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
    </button>
    <button class="btn btn-sm btn-outline-primary w-100" onclick="showCreateNotificationModalDashboard()" title="T·∫°o th√¥ng b√°o">
      <i class="bi bi-plus-lg"></i> T·∫°o th√¥ng b√°o
    </button>
  </div>
</div>

<!-- Main Content Area - Full Width -->
<div class="container-fluid" style="padding:20px;">
      <div class="row mb-4">
        <div class="col">
          <h1 class="display-4"><i class="bi bi-speedometer2"></i> Dashboard</h1>
          <p class="lead">Note v√†o v√† ƒë·ª´ng h·ªèi</p>
        </div>
      </div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title"><i class="bi bi-sticky"></i> T·ªïng Ghi ch√∫</h5>
                        <h2 class="mb-0">{{ notes_count }}</h2>
                    </div>
                    <div class="display-1 opacity-50">
                        <i class="bi bi-sticky-fill"></i>
                    </div>
                </div>
                <a href="{{ url_for('notes') }}" class="text-white text-decoration-none">
                    Xem t·∫•t c·∫£ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title"><i class="bi bi-file-earmark-text"></i> T·ªïng T√†i li·ªáu</h5>
                        <h2 class="mb-0">{{ docs_count }}</h2>
                    </div>
                    <div class="display-1 opacity-50">
                        <i class="bi bi-file-earmark-text-fill"></i>
                    </div>
                </div>
                <a href="{{ url_for('docs') }}" class="text-white text-decoration-none">
                    Xem t·∫•t c·∫£ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Categories List -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Danh m·ª•c ghi ch√∫</h5>
            </div>
            <div class="card-body">
                {% if categories_with_stats %}
                    <div class="row g-3">
                        {% for cat_stats in categories_with_stats %}
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100 category-card" 
                                 style="transition: transform 0.2s, box-shadow 0.2s;">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="mb-0">
                                            {% if cat_stats.has_children %}
                                            <i class="bi bi-folder"></i>
                                            <a href="{{ url_for('view_category', category_name=cat_stats.name) }}" class="text-decoration-none">
                                                {{ cat_stats.name }}
                                            </a>
                                            {% else %}
                                            <i class="bi bi-folder"></i>
                                            <a href="{{ url_for('notes', category=cat_stats.name) }}" class="text-decoration-none">
                                                {{ cat_stats.name }}
                                            </a>
                                            {% endif %}
                                        </h5>
                                        <span class="badge bg-primary">{{ cat_stats.count }}</span>
                                    </div>
                                    {% if cat_stats.recent_note %}
                                    <p class="text-muted mb-1 small" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        {{ cat_stats.recent_note.title | striptags }}
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> 
                                        {{ cat_stats.recent_date.strftime('%d/%m/%Y %H:%M') if cat_stats.recent_date else '' }}
                                    </small>
                                    {% else %}
                                    <p class="text-muted mb-0 small fst-italic">Ch∆∞a c√≥ ghi ch√∫</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center">Ch∆∞a c√≥ danh m·ª•c n√†o</p>
                    <div class="text-center">
                        {% if current_user.role == 'admin' %}
                        <a href="{{ url_for('manage_categories') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Qu·∫£n l√Ω danh m·ª•c
                        </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Thao t√°c nhanh</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if current_user.role != 'viewer' %}
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('new_note') }}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-plus-circle"></i> Ghi ch√∫ m·ªõi
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('new_doc') }}" class="btn btn-outline-success w-100">
                            <i class="bi bi-plus-circle"></i> T√†i li·ªáu m·ªõi
                        </a>
                    </div>
                    {% endif %}
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('search') }}" class="btn btn-outline-info w-100">
                            <i class="bi bi-search"></i> T√¨m ki·∫øm
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('notes') }}" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-list"></i> Xem t·∫•t c·∫£
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_css %}
<style>
.category-card {
    border: 3px solid #495057 !important;
    border-radius: 0.375rem;
}

[data-theme="dark"] .category-card {
    border: 3px solid #868e96 !important;
}

.category-card:hover {
    border-color: #212529 !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
}

[data-theme="dark"] .category-card:hover {
    border-color: #adb5bd !important;
    box-shadow: 0 4px 8px rgba(255,255,255,0.1) !important;
}

/* Notification Dropdown Trigger */
.notification-dropdown-trigger{position:fixed;top:70px;left:20px;z-index:1000}
.notification-dropdown-trigger .btn{box-shadow:0 4px 12px rgba(0,0,0,0.15);border-radius:8px;font-weight:600}
.notification-dropdown-trigger .badge{font-size:11px}

/* Notification Panel Dropdown */
.notification-panel-dropdown{position:fixed;top:120px;left:20px;width:400px;max-height:calc(100vh - 140px);background:white;border:2px solid #e0e0e0;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.15);display:flex;flex-direction:column;overflow:hidden;z-index:999;animation:slideDown 0.3s ease}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}

.notification-header-dashboard{padding:16px;border-bottom:2px solid #e0e0e0;background:#fff;border-top-left-radius:14px;border-top-right-radius:14px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.notification-header-dashboard h6{margin:0;font-weight:600;font-size:16px;color:#495057}
.notification-list-dashboard{flex:1;overflow-y:auto;padding:12px}
.notification-item-dashboard{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:12px;margin-bottom:10px;cursor:pointer;transition:all .2s ease;position:relative}
.notification-item-dashboard:hover{box-shadow:0 2px 8px rgba(0,0,0,0.1);transform:translateY(-1px)}
.notification-item-dashboard.unread{border-left:4px solid #667eea;background:#f8f9ff}
.notification-item-dashboard.unread::before{content:'';position:absolute;top:12px;right:12px;width:8px;height:8px;background:#667eea;border-radius:50%}
.notification-title{font-weight:600;font-size:14px;margin-bottom:4px;color:#212529}
.notification-message{font-size:13px;color:#6c757d;line-height:1.4;margin-bottom:6px;white-space:pre-wrap}
.notification-time{font-size:11px;color:#adb5bd}
.notification-type-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-bottom:6px}
.notification-type-info{background:#d1ecf1;color:#0c5460}
.notification-type-success{background:#d4edda;color:#155724}
.notification-type-warning{background:#fff3cd;color:#856404}
.notification-type-danger{background:#f8d7da;color:#721c24}
.notification-empty{text-align:center;padding:40px 20px;color:#adb5bd}
.notification-actions-dashboard{padding:12px;border-top:1px solid #e0e0e0;flex-shrink:0}

/* Dark Mode */
[data-theme="dark"] .notification-panel-dropdown{background:#2d2d2d;border-color:#404040}
[data-theme="dark"] .notification-header-dashboard{background:#2d2d2d;border-bottom-color:#404040}
[data-theme="dark"] .notification-header-dashboard h6{color:#e9ecef}
[data-theme="dark"] .notification-item-dashboard{background:#3a3a3a;border-color:#495057}
[data-theme="dark"] .notification-item-dashboard.unread{background:#2c3e50;border-left-color:#667eea}
[data-theme="dark"] .notification-title{color:#e9ecef}
[data-theme="dark"] .notification-message{color:#adb5bd}

/* Responsive */
@media(max-width:768px){
  .notification-dropdown-trigger{left:10px;top:65px}
  .notification-panel-dropdown{left:10px;right:10px;width:auto;top:110px}
}
</style>
{% endblock %}

{% block extra_js %}
<script src="/socket.io/socket.io.js"></script>
<script>
let dashboardSocket=null;

/* === Toggle Notification Panel === */
function toggleNotificationPanel(){
  const panel=document.getElementById('notificationPanelDropdown');
  if(panel.style.display==='none'){
    panel.style.display='flex';
    loadNotificationsDashboard();
  }else{
    panel.style.display='none';
  }
}

// Close panel when clicking outside
document.addEventListener('click',function(e){
  const panel=document.getElementById('notificationPanelDropdown');
  const btn=document.getElementById('notificationToggleBtn');
  if(panel&&btn&&panel.style.display==='flex'){
    if(!panel.contains(e.target)&&!btn.contains(e.target)){
      panel.style.display='none';
    }
  }
});

/* === Utility Functions === */
function escapeHtml(text){
  if(!text)return'';
  const div=document.createElement('div');
  div.textContent=text;
  return div.innerHTML.replace(/\n/g,'<br>');
}

function formatTime(iso){
  const d=new Date(iso);
  const diff=Date.now()-d.getTime();
  
  if(diff<60000)return'V·ª´a xong';
  if(diff<3600000)return Math.floor(diff/60000)+'p';
  if(diff<86400000)return Math.floor(diff/3600000)+'h';
  
  const today=new Date();
  const yesterday=new Date(today);
  yesterday.setDate(yesterday.getDate()-1);
  
  const isYesterday=d.toDateString()===yesterday.toDateString();
  const time=d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
  
  if(isYesterday)return'H√¥m qua '+time;
  return d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'})+' '+time;
}

/* === Load Notifications === */
async function loadNotificationsDashboard(){
  try{
    const r=await fetch('/notifications');
    const d=await r.json();
    if(d.success){
      displayNotificationsDashboard(d.notifications);
      updateNotificationCountDashboard();
    }
  }catch(e){console.error('Error loading notifications:',e);}
}

function displayNotificationsDashboard(notifications){
  const list=document.getElementById('dashboardNotificationList');
  if(!notifications||notifications.length===0){
    list.innerHTML=`
      <div class="notification-empty">
        <i class="bi bi-bell" style="font-size:48px;opacity:0.3"></i>
        <p class="mt-2">Ch∆∞a c√≥ th√¥ng b√°o</p>
      </div>
    `;
    return;
  }
  
  list.innerHTML='';
  notifications.forEach(n=>{
    const isUnread=!n.read_by.includes({{ current_user.id }});
    const div=document.createElement('div');
    div.className='notification-item-dashboard'+(isUnread?' unread':'');
    div.onclick=()=>handleNotificationClickDashboard(n.id,n.link);
    
    const typeClass='notification-type-'+n.type;
    const typeLabel={'info':'Th√¥ng tin','success':'Th√†nh c√¥ng','warning':'C·∫£nh b√°o','danger':'Quan tr·ªçng'}[n.type]||'Th√¥ng tin';
    
    div.innerHTML=`
      <div class="notification-type-badge ${typeClass}">${typeLabel}</div>
      <div class="notification-title">${escapeHtml(n.title)}</div>
      <div class="notification-message">${escapeHtml(n.message)}</div>
      <div class="notification-time">${formatTime(n.created_at)}</div>
    `;
    list.appendChild(div);
  });
}

async function handleNotificationClickDashboard(notificationId,link){
  try{
    await fetch(`/notifications/${notificationId}/read`,{method:'POST'});
    loadNotificationsDashboard();
    if(link){
      window.location.href=link;
    }
  }catch(e){console.error(e);}
}

async function updateNotificationCountDashboard(){
  try{
    const r=await fetch('/notifications/unread-count');
    const d=await r.json();
    const badge=document.getElementById('dashboardNotificationCount');
    if(d.success&&badge){
      badge.textContent=d.count;
      if(d.count>0){
        badge.style.display='inline-block';
        badge.className='badge bg-danger ms-2';
      }else{
        badge.style.display='none';
      }
    }
  }catch(e){console.error(e);}
}

async function markAllNotificationsReadDashboard(){
  try{
    const r=await fetch('/notifications/mark-all-read',{method:'POST'});
    const d=await r.json();
    if(d.success){
      loadNotificationsDashboard();
      showToastDashboard('‚úì ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o ƒë√£ ƒë·ªçc','success');
    }
  }catch(e){console.error(e);}
}

function showCreateNotificationModalDashboard(){
  const modal=document.createElement('div');
  modal.className='modal fade show d-block';
  modal.style.backgroundColor='rgba(0,0,0,0.5)';
  modal.innerHTML=`
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle"></i> T·∫°o th√¥ng b√°o</h5>
          <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
        </div>
        <div class="modal-body">
          <form id="createNotificationFormDashboard">
            <div class="mb-3">
              <label class="form-label">Ti√™u ƒë·ªÅ</label>
              <input type="text" class="form-control" id="notifTitleDashboard" required>
            </div>
            <div class="mb-3">
              <label class="form-label">N·ªôi dung</label>
              <textarea class="form-control" id="notifMessageDashboard" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Lo·∫°i</label>
              <select class="form-select" id="notifTypeDashboard">
                <option value="info">Th√¥ng tin</option>
                <option value="success">Th√†nh c√¥ng</option>
                <option value="warning">C·∫£nh b√°o</option>
                <option value="danger">Quan tr·ªçng</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Link (t√πy ch·ªçn)</label>
              <input type="text" class="form-control" id="notifLinkDashboard" placeholder="/dashboard">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="createNotificationDashboard()">T·∫°o th√¥ng b√°o</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function createNotificationDashboard(){
  const title=document.getElementById('notifTitleDashboard').value.trim();
  const message=document.getElementById('notifMessageDashboard').value.trim();
  const type=document.getElementById('notifTypeDashboard').value;
  const link=document.getElementById('notifLinkDashboard').value.trim()||null;
  
  if(!title||!message){
    showToastDashboard('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin','warning');
    return;
  }
  
  try{
    const r=await fetch('/notifications/create',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({title,message,type,link})
    });
    const d=await r.json();
    if(d.success){
      showToastDashboard('‚úì ƒê√£ t·∫°o th√¥ng b√°o','success');
      document.querySelector('.modal').remove();
      loadNotificationsDashboard();
    }else{
      showToastDashboard('‚úó '+d.error,'danger');
    }
  }catch(e){
    showToastDashboard('‚úó L·ªói: '+e.message,'danger');
  }
}

function showToastDashboard(message,type){
  const toast=document.createElement('div');
  toast.style.cssText='position:fixed;top:80px;right:20px;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;animation:slideIn 0.3s ease';
  const colors={'success':'#28a745','danger':'#dc3545','warning':'#ffc107','info':'#17a2b8'};
  toast.style.background=colors[type]||colors.info;
  toast.style.color='white';
  toast.innerHTML=message;
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(),3000);
}

/* === Socket.IO === */
function initDashboardSocket(){
  try{
    dashboardSocket=io({transports:['websocket','polling']});
    dashboardSocket.on('new_notification',(data)=>{
      loadNotificationsDashboard();
      showToastDashboard('üîî '+data.notification.title,'info');
    });
    dashboardSocket.on('notification_deleted',()=>{
      loadNotificationsDashboard();
    });
  }catch(e){console.error('Socket init failed',e);}
}

/* === Init === */
document.addEventListener('DOMContentLoaded',()=>{
  loadNotificationsDashboard();
  updateNotificationCountDashboard();
  initDashboardSocket();
  setInterval(updateNotificationCountDashboard,30000);
});
</script>
{% endblock %}

