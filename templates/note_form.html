{% extends "base.html" %}

{% block title %}{% if note %}Chỉnh sửa{% else %}Tạo mới{% endif %} Ghi chú - Hệ thống Quản lý Nội bộ{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('editor');
    const contentTextarea = document.getElementById('content');
    const titleEditor = document.getElementById('title-editor');
    const titleInput = document.getElementById('title');
    
    // Kiểm tra các element có tồn tại không
    if (!editor || !contentTextarea || !titleEditor || !titleInput) {
        console.error('Các element cần thiết không tìm thấy!');
        return;
    }
    
    // Sync content từ editor đến textarea trước khi submit
    const form = editor.closest('form');
    if (!form) {
        console.error('Form không tìm thấy!');
        return;
    }
    
    form.addEventListener('submit', function(e) {
        try {
            // Lấy HTML từ title editor để giữ định dạng (bold, italic, etc.)
            const titleText = titleEditor.innerText || titleEditor.textContent || '';
            const titleHTML = titleEditor.innerHTML || '';
            
            // Validation: Kiểm tra có nội dung thực sự (không chỉ HTML tags)
            if (!titleText.trim()) {
                e.preventDefault();
                alert('Vui lòng nhập tiêu đề!');
                titleEditor.focus();
                return false;
            }
            
            // Lưu HTML để giữ định dạng
            titleInput.value = titleHTML.trim();
            
            // Lấy nội dung HTML từ editor
            const contentHTML = editor.innerHTML || '';
            contentTextarea.value = contentHTML || '';
            
            console.log('Form submitted - Title:', titleText.substring(0, 50), 'Content length:', contentHTML.length);
        } catch (error) {
            console.error('Lỗi khi submit form:', error);
            // Vẫn cho phép submit nếu có lỗi nhỏ, để form validation của server xử lý
            // Chỉ điền giá trị cơ bản nếu có thể
            try {
                const titleText = titleEditor.innerText || titleEditor.textContent || '';
                if (titleText.trim()) {
                    titleInput.value = titleEditor.innerHTML || titleText;
                }
                const contentHTML = editor.innerHTML || '';
                contentTextarea.value = contentHTML || '';
            } catch (e2) {
                console.error('Lỗi khi điền giá trị dự phòng:', e2);
            }
        }
    });

    // Chọn màu nền cho tab ghi chú (khi đang chỉnh sửa)
    const colorWrap = document.getElementById('form-note-color');
    if (colorWrap) {
        const noteId = colorWrap.getAttribute('data-note-id');
        // Set trạng thái ban đầu theo localStorage
        const saved = localStorage.getItem('noteColor:' + noteId);
        if (saved) {
            // đánh dấu swatch
            const active = colorWrap.querySelector('[data-color="' + saved + '"]');
            if (active) active.style.outline = '2px solid #0d6efd';
        }
        colorWrap.querySelectorAll('.note-form-color').forEach(btn => {
            btn.addEventListener('click', function(){
                const color = btn.getAttribute('data-color');
                localStorage.setItem('noteColor:' + noteId, color);
                // highlight
                colorWrap.querySelectorAll('.note-form-color').forEach(b=> b.style.outline='');
                btn.style.outline = '2px solid #0d6efd';
            });
        });
        const clearBtn = document.getElementById('clearFormNoteColor');
        if (clearBtn) {
            clearBtn.addEventListener('click', function(){
                localStorage.removeItem('noteColor:' + noteId);
                colorWrap.querySelectorAll('.note-form-color').forEach(b=> b.style.outline='');
            });
        }
    }
    
    // Phím tắt cho content
    editor.addEventListener('keydown', function(e) {
        // Ctrl+B cho bold
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            formatText('bold');
        }
        // Ctrl+I cho italic
        if (e.ctrlKey && e.key === 'i') {
            e.preventDefault();
            formatText('italic');
        }
        // Ctrl+U cho underline
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            formatText('underline');
        }
    });
    
    // Phím tắt cho title
    titleEditor.addEventListener('keydown', function(e) {
        // Ctrl+B cho bold
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            formatTitleText('bold');
        }
        // Ctrl+I cho italic
        if (e.ctrlKey && e.key === 'i') {
            e.preventDefault();
            formatTitleText('italic');
        }
        // Ctrl+U cho underline
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            formatTitleText('underline');
        }
    });
});

function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('editor').focus();
}

function formatTextSize(size) {
    if (!size) return;
    
    const editor = document.getElementById('editor');
    const selection = window.getSelection();
    
    if (selection.rangeCount === 0) {
        editor.focus();
        return;
    }
    
    const range = selection.getRangeAt(0);
    
    if (selection.isCollapsed || range.collapsed) {
        // No text selected, create a span at cursor position for future typing
        const span = document.createElement('span');
        span.style.fontSize = size;
        span.innerHTML = '\u200B'; // Zero-width space
        range.insertNode(span);
        range.setStartAfter(span);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
        editor.focus();
    } else {
        // Text is selected, wrap it
        const span = document.createElement('span');
        span.style.fontSize = size;
        try {
            range.surroundContents(span);
        } catch (e) {
            // If surroundContents fails, extract and wrap
            const contents = range.extractContents();
            span.appendChild(contents);
            range.insertNode(span);
        }
        editor.focus();
    }
}

function formatTextColor(color) {
    document.execCommand('foreColor', false, color);
    document.getElementById('editor').focus();
}

function handlePaste(e) {
    e.preventDefault();
    const clipboardData = e.clipboardData || window.clipboardData;
    const editor = document.getElementById('editor');
    
    // Kiểm tra xem có hình ảnh trong clipboard không
    const items = clipboardData.items;
    let imageFound = false;
    
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            imageFound = true;
            const file = items[i].getAsFile();
            
            // Tạo tên file nếu chưa có
            if (!file.name) {
                const timestamp = Date.now();
                const ext = file.type.split('/')[1] || 'png';
                file.name = `pasted_image_${timestamp}.${ext}`;
            }
            
            // Thêm file vào danh sách đính kèm (sử dụng biến selectedFiles từ file upload handler)
            // Tìm file input và trigger change event
            const fileInput = document.getElementById('attachments');
            if (fileInput && typeof window.selectedFiles !== 'undefined') {
                // Kiểm tra file đã tồn tại chưa (theo tên và kích thước)
                const exists = window.selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    window.selectedFiles.push(file);
                    
                    // Cập nhật file input
                    const dt = new DataTransfer();
                    window.selectedFiles.forEach(f => {
                        dt.items.add(f);
                    });
                    fileInput.files = dt.files;
                    
                    // Trigger render preview
                    if (typeof window.renderFilePreview === 'function') {
                        window.renderFilePreview();
                    } else {
                        // Fallback: trigger change event
                        fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    // Hiển thị thông báo
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    notification.style.zIndex = '9999';
                    notification.innerHTML = `
                        <i class="bi bi-check-circle"></i> Đã thêm hình ảnh vào danh sách đính kèm
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(notification);
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 3000);
                }
            }
            
            break;
        }
    }
    
    // Nếu không có hình ảnh, xử lý paste text như bình thường
    if (!imageFound) {
        // Ưu tiên lấy HTML để giữ định dạng
        let html = clipboardData.getData('text/html');
        
        if (html) {
            // Nếu có HTML, insert trực tiếp
            document.execCommand('insertHTML', false, html);
        } else {
            // Nếu không có HTML, lấy text và chuyển đổi xuống dòng
            let text = clipboardData.getData('text/plain');
            
            // Chuyển đổi các ký tự xuống dòng thành <br>
            // Giữ nhiều dòng trống thành <br><br>
            text = text
                .replace(/\r\n/g, '\n')  // Chuẩn hóa Windows line breaks
                .replace(/\r/g, '\n')    // Chuẩn hóa Mac line breaks
                .replace(/\n\n+/g, '\n\n') // Giữ tối đa 2 dòng trống liên tiếp
                .replace(/\n/g, '<br>');   // Chuyển đổi \n thành <br>
            
            document.execCommand('insertHTML', false, text);
        }
        
        // Focus lại editor sau khi paste
        editor.focus();
    }
}

// Functions for title editor
function formatTitleText(command) {
    document.execCommand(command, false, null);
    document.getElementById('title-editor').focus();
}

function formatTitleTextSize(size) {
    if (!size) return;
    
    const editor = document.getElementById('title-editor');
    const selection = window.getSelection();
    
    if (selection.rangeCount === 0) {
        editor.focus();
        return;
    }
    
    const range = selection.getRangeAt(0);
    
    if (selection.isCollapsed || range.collapsed) {
        // No text selected, create a span at cursor position for future typing
        const span = document.createElement('span');
        span.style.fontSize = size;
        span.innerHTML = '\u200B'; // Zero-width space
        range.insertNode(span);
        range.setStartAfter(span);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
        editor.focus();
    } else {
        // Text is selected, wrap it
        const span = document.createElement('span');
        span.style.fontSize = size;
        try {
            range.surroundContents(span);
        } catch (e) {
            // If surroundContents fails, extract and wrap
            const contents = range.extractContents();
            span.appendChild(contents);
            range.insertNode(span);
        }
        editor.focus();
    }
}

function formatTitleTextColor(color) {
    document.execCommand('foreColor', false, color);
    document.getElementById('title-editor').focus();
}

function handleTitlePaste(e) {
    e.preventDefault();
    const clipboardData = e.clipboardData || window.clipboardData;
    
    // Ưu tiên lấy HTML để giữ định dạng
    let html = clipboardData.getData('text/html');
    
    if (html) {
        // Nếu có HTML, insert trực tiếp nhưng loại bỏ các thẻ block (p, div) vì tiêu đề nên là inline
        html = html.replace(/<\/?(p|div|h[1-6])[^>]*>/gi, '').trim();
        document.execCommand('insertHTML', false, html);
    } else {
        // Nếu không có HTML, lấy text và chuyển đổi xuống dòng thành space
        let text = clipboardData.getData('text/plain');
        
        // Trong tiêu đề, xuống dòng sẽ thành space
        text = text
            .replace(/\r\n/g, ' ')
            .replace(/\r/g, ' ')
            .replace(/\n/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
        
        document.execCommand('insertHTML', false, text);
    }
    
    // Focus lại title editor sau khi paste
    document.getElementById('title-editor').focus();
}

// File upload preview handler
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('attachments');
    const filePreview = document.getElementById('filePreview');
    const fileList = document.getElementById('fileList');
    let selectedFiles = [];
    
    // Expose selectedFiles để handlePaste có thể sử dụng
    window.selectedFiles = selectedFiles;
    
    function renderFilePreview() {
        fileList.innerHTML = '';
        
        if (selectedFiles.length > 0) {
            filePreview.style.display = 'block';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'col-md-3 col-sm-4 col-6';
                fileItem.setAttribute('data-file-index', index);
                
                const isImage = file.type.startsWith('image/');
                const fileSize = (file.size / 1024).toFixed(1); // KB
                
                let previewContent = '';
                if (isImage) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = fileItem.querySelector('img');
                        if (img) img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    previewContent = `
                        <div class="card mb-2 shadow-sm position-relative">
                            <div class="position-relative">
                                <img src="" alt="${file.name}" class="card-img-top" style="height: 150px; object-fit: cover; background: #f0f0f0;">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-file-btn" 
                                        data-file-index="${index}" style="opacity: 0.9; z-index: 10;">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                            <div class="card-body p-2">
                                <small class="text-truncate d-block" title="${file.name}">${file.name}</small>
                                <small class="text-muted">${fileSize} KB</small>
                            </div>
                        </div>
                    `;
                } else {
                    let icon = 'bi-file-earmark';
                    if (file.type.includes('pdf')) icon = 'bi-file-earmark-pdf';
                    else if (file.type.includes('word') || file.name.match(/\.(doc|docx)$/i)) icon = 'bi-file-earmark-word';
                    else if (file.type.includes('excel') || file.name.match(/\.(xls|xlsx)$/i)) icon = 'bi-file-earmark-excel';
                    else if (file.type.includes('zip') || file.name.match(/\.(zip|rar)$/i)) icon = 'bi-file-earmark-zip';
                    else if (file.type.includes('text') || file.name.match(/\.txt$/i)) icon = 'bi-file-earmark-text';
                    
                    previewContent = `
                        <div class="card mb-2 shadow-sm position-relative">
                            <div class="card-body text-center">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-file-btn" 
                                        data-file-index="${index}" style="opacity: 0.9; z-index: 10;">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                <i class="bi ${icon}" style="font-size: 3rem; color: #6c757d;"></i>
                                <p class="card-text">
                                    <small class="text-truncate d-block" title="${file.name}">${file.name}</small>
                                    <small class="text-muted">${fileSize} KB</small>
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                fileItem.innerHTML = previewContent;
                fileList.appendChild(fileItem);
            });
        } else {
            filePreview.style.display = 'none';
        }
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            // Merge with existing files if user selects more
            if (selectedFiles.length > 0) {
                // Add new files to existing ones
                newFiles.forEach(file => {
                    // Check if file already exists (by name and size)
                    const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                    if (!exists) {
                        selectedFiles.push(file);
                    }
                });
            } else {
                selectedFiles = newFiles;
            }
            
            // Update global reference
            window.selectedFiles = selectedFiles;
            
            // Update file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => {
                dt.items.add(file);
            });
            fileInput.files = dt.files;
            
            renderFilePreview();
        });
        
        // Expose renderFilePreview sau khi đã định nghĩa
        window.renderFilePreview = renderFilePreview;
        
        // Handle remove file button
        fileList.addEventListener('click', function(e) {
            if (e.target.closest('.remove-file-btn')) {
                const btn = e.target.closest('.remove-file-btn');
                const fileIndex = parseInt(btn.getAttribute('data-file-index'));
                
                if (fileIndex >= 0 && fileIndex < selectedFiles.length) {
                    // Remove from selectedFiles array
                    selectedFiles.splice(fileIndex, 1);
                    
                    // Update global reference
                    window.selectedFiles = selectedFiles;
                    
                    // Update file input
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => {
                        dt.items.add(file);
                    });
                    fileInput.files = dt.files;
                    
                    // Re-render preview
                    renderFilePreview();
                }
            }
        });
    }
});
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="bi bi-{% if note %}pencil{% else %}plus-circle{% endif %}"></i>
                    {% if note %}Chỉnh sửa Ghi chú{% else %}Ghi chú Mới{% endif %}
                </h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Tiêu đề</label>
                        <div id="title-toolbar" class="border rounded-top p-2 bg-light">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatTitleText('bold')" title="In đậm">
                                <i class="bi bi-type-bold"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatTitleText('italic')" title="In nghiêng">
                                <i class="bi bi-type-italic"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatTitleText('underline')" title="Gạch chân">
                                <i class="bi bi-type-underline"></i>
                            </button>
                            <span class="border-start mx-2"></span>
                            <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="formatTitleTextSize(this.value)" title="Kích thước chữ">
                                <option value="">Kích thước</option>
                                <option value="14px">14px</option>
                                <option value="16px" selected>16px</option>
                                <option value="18px">18px</option>
                                <option value="20px">20px</option>
                                <option value="24px">24px</option>
                                <option value="28px">28px</option>
                                <option value="32px">32px</option>
                                <option value="36px">36px</option>
                            </select>
                            <span class="border-start mx-2"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatTitleText('removeFormat')" title="Xóa định dạng">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        <div id="title-editor" contenteditable="true" class="form-control border rounded-bottom" 
                             style="min-height: 50px; padding: 10px; overflow-y: auto; font-size: 1.1rem; font-weight: 500;"
                             onpaste="handleTitlePaste(event)">{{ note.title | safe if note else '' }}</div>
                        <input type="text" id="title" name="title" style="display: none;">
                        <small class="form-text text-muted">Bạn có thể định dạng tiêu đề bằng các công cụ trên</small>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Danh mục</label>
                        <select class="form-select" id="category" name="category" required>
                            {% for cat in categories %}
                                <option value="{{ cat }}" {% if (note and note.category == cat) or (not note and cat == 'general') %}selected{% endif %}>
                                    {{ cat }}
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Chọn danh mục từ danh sách có sẵn</small>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Nội dung</label>
                        <div id="editor-toolbar" class="border rounded-top p-2 bg-light">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="In đậm">
                                <i class="bi bi-type-bold"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="In nghiêng">
                                <i class="bi bi-type-italic"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="Gạch chân">
                                <i class="bi bi-type-underline"></i>
                            </button>
                            <span class="border-start mx-2"></span>
                            <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="formatTextSize(this.value)" title="Kích thước chữ">
                                <option value="">Kích thước</option>
                                <option value="8px">8px</option>
                                <option value="10px">10px</option>
                                <option value="12px">12px</option>
                                <option value="14px" selected>14px</option>
                                <option value="16px">16px</option>
                                <option value="18px">18px</option>
                                <option value="20px">20px</option>
                                <option value="24px">24px</option>
                                <option value="28px">28px</option>
                                <option value="32px">32px</option>
                            </select>
                            <span class="border-start mx-2"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('removeFormat')" title="Xóa định dạng">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        <div id="editor" contenteditable="true" class="form-control border rounded-bottom" 
                             style="min-height: 300px; padding: 15px; overflow-y: auto;"
                             onpaste="handlePaste(event)">{{ note.content | safe if note else '' }}</div>
                        <textarea id="content" name="content" style="display: none;"></textarea>
                        <small class="form-text text-muted">Bạn có thể định dạng text bằng các công cụ trên hoặc phím tắt: Ctrl+B (đậm), Ctrl+I (nghiêng)</small>
                    </div>
                    <div class="mb-3">
                        <label for="attachments" class="form-label">
                            <i class="bi bi-paperclip"></i> Đính kèm file
                        </label>
                        <input type="file" class="form-control" id="attachments" name="attachments" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar">
                        <small class="form-text text-muted">Có thể chọn nhiều file cùng lúc (hình ảnh, tài liệu PDF, Word, Excel, v.v.)</small>
                        
                        <!-- Preview Area for Selected Files -->
                        <div id="filePreview" class="mt-3" style="display: none;">
                            <label class="form-label">Files đã chọn:</label>
                            <div id="fileList" class="row g-2"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Màu nền tab ghi chú</label>
                        {% if note %}
                        <div class="d-flex flex-wrap gap-2" id="form-note-color" data-note-id="{{ note.id }}">
                            {% set colors = ['#ffffff', '#f5f5f5', '#fffbe6', '#e6f7ff', '#f6ffed', '#fff0f6', '#f0f5ff', '#f9f0ff', '#f0fff4'] %}
                            {% for c in colors %}
                            <button type="button" class="border note-form-color" data-color="{{ c }}" style="width:24px;height:24px;border-radius:4px;background: {{ c }};"></button>
                            {% endfor %}
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="clearFormNoteColor">
                                <i class="bi bi-eraser"></i> Xóa màu
                            </button>
                        </div>
                        <small class="form-text text-muted">Áp dụng cho thẻ ghi chú ở danh sách sau khi lưu.</small>
                        {% else %}
                        <div class="text-muted">Chọn màu nền có thể thực hiện sau khi tạo (menu 3 chấm của ghi chú).</div>
                        {% endif %}
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('notes') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Hủy
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Lưu
                        </button>
                    </div>
                </form>

                {% if note and note.attachments %}
                <div class="mb-3 mt-3">
                    <label class="form-label">File đính kèm hiện có:</label>
                    <div class="list-group">
                        {% for attachment in note.attachments %}
                        {% set filename = attachment.get('filename', '') %}
                        {% set original_filename = attachment.get('original_filename', filename) %}
                        {% set is_image = filename.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp')) %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    {% if is_image %}
                                    <div class="mb-2">
                                        <img src="{{ url_for('download_attachment', note_id=note.id, filename=filename) }}"
                                             class="img-thumbnail"
                                             style="max-width: 200px; max-height: 150px; object-fit: cover;"
                                             alt="{{ original_filename }}">
                                    </div>
                                    {% endif %}
                                    <div>
                                        <i class="bi bi-file-earmark"></i>
                                        <a href="{{ url_for('download_attachment', note_id=note.id, filename=filename) }}" target="_blank">
                                            {{ original_filename }}
                                        </a>
                                        {% if is_image %}
                                        <span class="badge bg-info ms-2">Hình ảnh</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if current_user.role != 'viewer' %}
                                <form method="post" action="{{ url_for('delete_attachment', note_id=note.id, filename=filename) }}"
                                      onsubmit="return confirm('Bạn có chắc muốn xóa file này?');" class="d-inline ms-2">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark bg-opacity-75 border-0" style="box-shadow:0 0 32px #000;">
      <div class="modal-header border-0" style="border-bottom:none;">
        <h5 class="modal-title text-white" id="imageModalLabel">Xem ảnh lớn</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body d-flex justify-content-center align-items-center" style="min-height:50vh;">
        <img id="modalImage" src="" style="max-width:90vw; max-height:80vh; border-radius:10px; background:white; box-shadow:0 0 40px 0 #000; object-fit:contain;" />
      </div>
    </div>
  </div>
</div>

