{% extends "base.html" %}

{% block title %}{% if note %}Ch·ªânh s·ª≠a{% else %}T·∫°o m·ªõi{% endif %} Ghi ch√∫ - H·ªá th·ªëng Qu·∫£n l√Ω N·ªôi b·ªô{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('editor');
    const contentTextarea = document.getElementById('content');
    const titleEditor = document.getElementById('title-editor');
    const titleInput = document.getElementById('title');
    
    // Ki·ªÉm tra c√°c element c√≥ t·ªìn t·∫°i kh√¥ng
    if (!editor || !contentTextarea || !titleEditor || !titleInput) {
        console.error('C√°c element c·∫ßn thi·∫øt kh√¥ng t√¨m th·∫•y!');
        return;
    }
    
    // Sync content t·ª´ editor ƒë·∫øn textarea tr∆∞·ªõc khi submit
    const form = editor.closest('form');
    if (!form) {
        console.error('Form kh√¥ng t√¨m th·∫•y!');
        return;
    }
    
    form.addEventListener('submit', function(e) {
        try {
            // L·∫•y HTML t·ª´ title editor ƒë·ªÉ gi·ªØ ƒë·ªãnh d·∫°ng (bold, italic, etc.)
            const titleText = titleEditor.innerText || titleEditor.textContent || '';
            const titleHTML = titleEditor.innerHTML || '';
            
            // Validation: Ki·ªÉm tra c√≥ n·ªôi dung th·ª±c s·ª± (kh√¥ng ch·ªâ HTML tags)
            if (!titleText.trim()) {
                e.preventDefault();
                alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!');
                titleEditor.focus();
                return false;
            }
            
            // L∆∞u HTML ƒë·ªÉ gi·ªØ ƒë·ªãnh d·∫°ng
            titleInput.value = titleHTML.trim();
            
            // L·∫•y n·ªôi dung HTML t·ª´ editor
            const contentHTML = editor.innerHTML || '';
            contentTextarea.value = contentHTML || '';
            
            console.log('Form submitted - Title:', titleText.substring(0, 50), 'Content length:', contentHTML.length);
        } catch (error) {
            console.error('L·ªói khi submit form:', error);
            // V·∫´n cho ph√©p submit n·∫øu c√≥ l·ªói nh·ªè, ƒë·ªÉ form validation c·ªßa server x·ª≠ l√Ω
            // Ch·ªâ ƒëi·ªÅn gi√° tr·ªã c∆° b·∫£n n·∫øu c√≥ th·ªÉ
            try {
                const titleText = titleEditor.innerText || titleEditor.textContent || '';
                if (titleText.trim()) {
                    titleInput.value = titleEditor.innerHTML || titleText;
                }
                const contentHTML = editor.innerHTML || '';
                contentTextarea.value = contentHTML || '';
            } catch (e2) {
                console.error('L·ªói khi ƒëi·ªÅn gi√° tr·ªã d·ª± ph√≤ng:', e2);
            }
        }
    });

    // Ch·ªçn m√†u n·ªÅn cho tab ghi ch√∫ (khi ƒëang ch·ªânh s·ª≠a)
    const colorWrap = document.getElementById('form-note-color');
    if (colorWrap) {
        const noteId = colorWrap.getAttribute('data-note-id');
        // Set tr·∫°ng th√°i ban ƒë·∫ßu theo localStorage
        const saved = localStorage.getItem('noteColor:' + noteId);
        if (saved) {
            // ƒë√°nh d·∫•u swatch
            const active = colorWrap.querySelector('[data-color="' + saved + '"]');
            if (active) active.style.outline = '2px solid #0d6efd';
        }
        colorWrap.querySelectorAll('.note-form-color').forEach(btn => {
            btn.addEventListener('click', function(){
                const color = btn.getAttribute('data-color');
                localStorage.setItem('noteColor:' + noteId, color);
                // highlight
                colorWrap.querySelectorAll('.note-form-color').forEach(b=> b.style.outline='');
                btn.style.outline = '2px solid #0d6efd';
            });
        });
        const clearBtn = document.getElementById('clearFormNoteColor');
        if (clearBtn) {
            clearBtn.addEventListener('click', function(){
                localStorage.removeItem('noteColor:' + noteId);
                colorWrap.querySelectorAll('.note-form-color').forEach(b=> b.style.outline='');
            });
        }
    }
    
    // Ph√≠m t·∫Øt cho content
    editor.addEventListener('keydown', function(e) {
        // Ctrl+B cho bold
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            formatText('bold');
        }
        // Ctrl+I cho italic
        if (e.ctrlKey && e.key === 'i') {
            e.preventDefault();
            formatText('italic');
        }
        // Ctrl+U cho underline
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            formatText('underline');
        }
    });
    
    // Ph√≠m t·∫Øt cho title
    titleEditor.addEventListener('keydown', function(e) {
        // Ctrl+B cho bold
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            formatTitleText('bold');
        }
        // Ctrl+I cho italic
        if (e.ctrlKey && e.key === 'i') {
            e.preventDefault();
            formatTitleText('italic');
        }
        // Ctrl+U cho underline
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            formatTitleText('underline');
        }
    });
});

function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('editor').focus();
}

function formatTextSize(size) {
    if (!size) return;
    
    const editor = document.getElementById('editor');
    const selection = window.getSelection();
    
    if (selection.rangeCount === 0) {
        editor.focus();
        return;
    }
    
    const range = selection.getRangeAt(0);
    
    if (selection.isCollapsed || range.collapsed) {
        // No text selected, create a span at cursor position for future typing
        const span = document.createElement('span');
        span.style.fontSize = size;
        span.innerHTML = '\u200B'; // Zero-width space
        range.insertNode(span);
        range.setStartAfter(span);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
        editor.focus();
    } else {
        // Text is selected, wrap it
        const span = document.createElement('span');
        span.style.fontSize = size;
        try {
            range.surroundContents(span);
        } catch (e) {
            // If surroundContents fails, extract and wrap
            const contents = range.extractContents();
            span.appendChild(contents);
            range.insertNode(span);
        }
        editor.focus();
    }
}

function formatTextColor(color) {
    document.execCommand('foreColor', false, color);
    document.getElementById('editor').focus();
}

function handlePaste(e) {
    e.preventDefault();
    const clipboardData = e.clipboardData || window.clipboardData;
    const editor = document.getElementById('editor');
    
    // Ki·ªÉm tra xem c√≥ h√¨nh ·∫£nh trong clipboard kh√¥ng
    const items = clipboardData.items;
    let imageFound = false;
    
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            imageFound = true;
            const file = items[i].getAsFile();
            
            // T·∫°o t√™n file n·∫øu ch∆∞a c√≥
            if (!file.name) {
                const timestamp = Date.now();
                const ext = file.type.split('/')[1] || 'png';
                file.name = `pasted_image_${timestamp}.${ext}`;
            }
            
            // Th√™m file v√†o danh s√°ch ƒë√≠nh k√®m (s·ª≠ d·ª•ng bi·∫øn selectedFiles t·ª´ file upload handler)
            // T√¨m file input v√† trigger change event
            const fileInput = document.getElementById('attachments');
            if (fileInput && typeof window.selectedFiles !== 'undefined') {
                // Ki·ªÉm tra file ƒë√£ t·ªìn t·∫°i ch∆∞a (theo t√™n v√† k√≠ch th∆∞·ªõc)
                const exists = window.selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    window.selectedFiles.push(file);
                    
                    // C·∫≠p nh·∫≠t file input
                    const dt = new DataTransfer();
                    window.selectedFiles.forEach(f => {
                        dt.items.add(f);
                    });
                    fileInput.files = dt.files;
                    
                    // Trigger render preview
                    if (typeof window.renderFilePreview === 'function') {
                        window.renderFilePreview();
                    } else {
                        // Fallback: trigger change event
                        fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    notification.style.zIndex = '9999';
                    notification.innerHTML = `
                        <i class="bi bi-check-circle"></i> ƒê√£ th√™m h√¨nh ·∫£nh v√†o danh s√°ch ƒë√≠nh k√®m
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(notification);
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 3000);
                }
            }
            
            break;
        }
    }
    
    // N·∫øu kh√¥ng c√≥ h√¨nh ·∫£nh, x·ª≠ l√Ω paste text nh∆∞ b√¨nh th∆∞·ªùng
    if (!imageFound) {
        // ∆Øu ti√™n l·∫•y HTML ƒë·ªÉ gi·ªØ ƒë·ªãnh d·∫°ng
        let html = clipboardData.getData('text/html');
        
        if (html) {
            // N·∫øu c√≥ HTML, insert tr·ª±c ti·∫øp
            document.execCommand('insertHTML', false, html);
        } else {
            // N·∫øu kh√¥ng c√≥ HTML, l·∫•y text v√† chuy·ªÉn ƒë·ªïi xu·ªëng d√≤ng
            let text = clipboardData.getData('text/plain');
            
            // Chuy·ªÉn ƒë·ªïi c√°c k√Ω t·ª± xu·ªëng d√≤ng th√†nh <br>
            // Gi·ªØ nhi·ªÅu d√≤ng tr·ªëng th√†nh <br><br>
            text = text
                .replace(/\r\n/g, '\n')  // Chu·∫©n h√≥a Windows line breaks
                .replace(/\r/g, '\n')    // Chu·∫©n h√≥a Mac line breaks
                .replace(/\n\n+/g, '\n\n') // Gi·ªØ t·ªëi ƒëa 2 d√≤ng tr·ªëng li√™n ti·∫øp
                .replace(/\n/g, '<br>');   // Chuy·ªÉn ƒë·ªïi \n th√†nh <br>
            
            document.execCommand('insertHTML', false, text);
        }
        
        // Focus l·∫°i editor sau khi paste
        editor.focus();
    }
}

// Functions for title editor
function formatTitleText(command) {
    document.execCommand(command, false, null);
    document.getElementById('title-editor').focus();
}

function formatTitleTextSize(size) {
    if (!size) return;
    
    const editor = document.getElementById('title-editor');
    const selection = window.getSelection();
    
    if (selection.rangeCount === 0) {
        editor.focus();
        return;
    }
    
    const range = selection.getRangeAt(0);
    
    if (selection.isCollapsed || range.collapsed) {
        // No text selected, create a span at cursor position for future typing
        const span = document.createElement('span');
        span.style.fontSize = size;
        span.innerHTML = '\u200B'; // Zero-width space
        range.insertNode(span);
        range.setStartAfter(span);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
        editor.focus();
    } else {
        // Text is selected, wrap it
        const span = document.createElement('span');
        span.style.fontSize = size;
        try {
            range.surroundContents(span);
        } catch (e) {
            // If surroundContents fails, extract and wrap
            const contents = range.extractContents();
            span.appendChild(contents);
            range.insertNode(span);
        }
        editor.focus();
    }
}

function formatTitleTextColor(color) {
    document.execCommand('foreColor', false, color);
    document.getElementById('title-editor').focus();
}

function handleTitlePaste(e) {
    e.preventDefault();
    const clipboardData = e.clipboardData || window.clipboardData;
    
    // ∆Øu ti√™n l·∫•y HTML ƒë·ªÉ gi·ªØ ƒë·ªãnh d·∫°ng
    let html = clipboardData.getData('text/html');
    
    if (html) {
        // N·∫øu c√≥ HTML, insert tr·ª±c ti·∫øp nh∆∞ng lo·∫°i b·ªè c√°c th·∫ª block (p, div) v√¨ ti√™u ƒë·ªÅ n√™n l√† inline
        html = html.replace(/<\/?(p|div|h[1-6])[^>]*>/gi, '').trim();
        document.execCommand('insertHTML', false, html);
    } else {
        // N·∫øu kh√¥ng c√≥ HTML, l·∫•y text v√† chuy·ªÉn ƒë·ªïi xu·ªëng d√≤ng th√†nh space
        let text = clipboardData.getData('text/plain');
        
        // Trong ti√™u ƒë·ªÅ, xu·ªëng d√≤ng s·∫Ω th√†nh space
        text = text
            .replace(/\r\n/g, ' ')
            .replace(/\r/g, ' ')
            .replace(/\n/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
        
        document.execCommand('insertHTML', false, text);
    }
    
    // Focus l·∫°i title editor sau khi paste
    document.getElementById('title-editor').focus();
}

// File upload preview handler
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('attachments');
    const filePreview = document.getElementById('filePreview');
    const fileList = document.getElementById('fileList');
    let selectedFiles = [];
    
    // Expose selectedFiles ƒë·ªÉ handlePaste c√≥ th·ªÉ s·ª≠ d·ª•ng
    window.selectedFiles = selectedFiles;
    
    function renderFilePreview() {
        fileList.innerHTML = '';
        
        if (selectedFiles.length > 0) {
            filePreview.style.display = 'block';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'col-md-3 col-sm-4 col-6';
                fileItem.setAttribute('data-file-index', index);
                
                const isImage = file.type.startsWith('image/');
                const fileSize = (file.size / 1024).toFixed(1); // KB
                
                let previewContent = '';
                if (isImage) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = fileItem.querySelector('img');
                        if (img) img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    previewContent = `
                        <div class="card mb-2 shadow-sm position-relative">
                            <div class="position-relative">
                                <img src="" alt="${file.name}" class="card-img-top" style="height: 150px; object-fit: cover; background: #f0f0f0;">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-file-btn" 
                                        data-file-index="${index}" style="opacity: 0.9; z-index: 10;">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                            <div class="card-body p-2">
                                <small class="text-truncate d-block" title="${file.name}">${file.name}</small>
                                <small class="text-muted">${fileSize} KB</small>
                            </div>
                        </div>
                    `;
                } else {
                    let icon = 'bi-file-earmark';
                    if (file.type.includes('pdf')) icon = 'bi-file-earmark-pdf';
                    else if (file.type.includes('word') || file.name.match(/\.(doc|docx)$/i)) icon = 'bi-file-earmark-word';
                    else if (file.type.includes('excel') || file.name.match(/\.(xls|xlsx)$/i)) icon = 'bi-file-earmark-excel';
                    else if (file.type.includes('zip') || file.name.match(/\.(zip|rar)$/i)) icon = 'bi-file-earmark-zip';
                    else if (file.type.includes('text') || file.name.match(/\.txt$/i)) icon = 'bi-file-earmark-text';
                    
                    previewContent = `
                        <div class="card mb-2 shadow-sm position-relative">
                            <div class="card-body text-center">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-file-btn" 
                                        data-file-index="${index}" style="opacity: 0.9; z-index: 10;">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                <i class="bi ${icon}" style="font-size: 3rem; color: #6c757d;"></i>
                                <p class="card-text">
                                    <small class="text-truncate d-block" title="${file.name}">${file.name}</small>
                                    <small class="text-muted">${fileSize} KB</small>
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                fileItem.innerHTML = previewContent;
                fileList.appendChild(fileItem);
            });
        } else {
            filePreview.style.display = 'none';
        }
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            // Merge with existing files if user selects more
            if (selectedFiles.length > 0) {
                // Add new files to existing ones
                newFiles.forEach(file => {
                    // Check if file already exists (by name and size)
                    const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                    if (!exists) {
                        selectedFiles.push(file);
                    }
                });
            } else {
                selectedFiles = newFiles;
            }
            
            // Update global reference
            window.selectedFiles = selectedFiles;
            
            // Update file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => {
                dt.items.add(file);
            });
            fileInput.files = dt.files;
            
            renderFilePreview();
        });
        
        // Expose renderFilePreview sau khi ƒë√£ ƒë·ªãnh nghƒ©a
        window.renderFilePreview = renderFilePreview;
        
        // Handle remove file button
        fileList.addEventListener('click', function(e) {
            if (e.target.closest('.remove-file-btn')) {
                const btn = e.target.closest('.remove-file-btn');
                const fileIndex = parseInt(btn.getAttribute('data-file-index'));
                
                if (fileIndex >= 0 && fileIndex < selectedFiles.length) {
                    // Remove from selectedFiles array
                    selectedFiles.splice(fileIndex, 1);
                    
                    // Update global reference
                    window.selectedFiles = selectedFiles;
                    
                    // Update file input
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => {
                        dt.items.add(file);
                    });
                    fileInput.files = dt.files;
                    
                    // Re-render preview
                    renderFilePreview();
                }
            }
        });
    }
});
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="bi bi-{% if note %}pencil{% else %}plus-circle{% endif %}"></i>
                    {% if note %}Ch·ªânh s·ª≠a Ghi ch√∫{% else %}Ghi ch√∫ M·ªõi{% endif %}
                </h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Ti√™u ƒë·ªÅ</label>
                        <div id="title-toolbar" class="border rounded-top p-2 bg-light">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatTitleText('bold')" title="In ƒë·∫≠m">
                                <i class="bi bi-type-bold"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatTitleText('italic')" title="In nghi√™ng">
                                <i class="bi bi-type-italic"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatTitleText('underline')" title="G·∫°ch ch√¢n">
                                <i class="bi bi-type-underline"></i>
                            </button>
                            <span class="border-start mx-2"></span>
                            <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="formatTitleTextSize(this.value)" title="K√≠ch th∆∞·ªõc ch·ªØ">
                                <option value="">K√≠ch th∆∞·ªõc</option>
                                <option value="14px">14px</option>
                                <option value="16px" selected>16px</option>
                                <option value="18px">18px</option>
                                <option value="20px">20px</option>
                                <option value="24px">24px</option>
                                <option value="28px">28px</option>
                                <option value="32px">32px</option>
                                <option value="36px">36px</option>
                            </select>
                            <span class="border-start mx-2"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatTitleText('removeFormat')" title="X√≥a ƒë·ªãnh d·∫°ng">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        <div id="title-editor" contenteditable="true" class="form-control border rounded-bottom" 
                             style="min-height: 50px; padding: 10px; overflow-y: auto; font-size: 1.1rem; font-weight: 500;"
                             onpaste="handleTitlePaste(event)">{{ note.title | safe if note else '' }}</div>
                        <input type="text" id="title" name="title" style="display: none;">
                        <small class="form-text text-muted">B·∫°n c√≥ th·ªÉ ƒë·ªãnh d·∫°ng ti√™u ƒë·ªÅ b·∫±ng c√°c c√¥ng c·ª• tr√™n</small>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Danh m·ª•c</label>
                        <select class="form-select" id="category" name="category" required>
                            {% if categories_dict %}
                                {# Hi·ªÉn th·ªã theo c·∫•u tr√∫c ph√¢n c·∫•p #}
                                {% for cat_name, cat_data in categories_dict.items() %}
                                    {% if not cat_data.parent %}
                                        {# Danh m·ª•c g·ªëc #}
                                        <option value="{{ cat_name }}" {% if (note and note.category == cat_name) or (not note and cat_name == 'general') %}selected{% endif %}>
                                            üìÅ {{ cat_name }}
                                        </option>
                                        {# Danh m·ª•c con #}
                                        {% if cat_data.children %}
                                            {% for child_name in cat_data.children %}
                                                <option value="{{ child_name }}" {% if note and note.category == child_name %}selected{% endif %}>
                                                    &nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ {{ child_name }}
                                                </option>
                                            {% endfor %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {# Fallback cho format c≈© #}
                                {% for cat in categories %}
                                    <option value="{{ cat }}" {% if (note and note.category == cat) or (not note and cat == 'general') %}selected{% endif %}>
                                        {{ cat }}
                                    </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        <small class="form-text text-muted">Danh m·ª•c con s·∫Ω hi·ªÉn th·ªã th·ª•t v√†o b√™n d∆∞·ªõi danh m·ª•c cha</small>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">N·ªôi dung</label>
                        <div id="editor-toolbar" class="border rounded-top p-2 bg-light">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="In ƒë·∫≠m">
                                <i class="bi bi-type-bold"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="In nghi√™ng">
                                <i class="bi bi-type-italic"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="G·∫°ch ch√¢n">
                                <i class="bi bi-type-underline"></i>
                            </button>
                            <span class="border-start mx-2"></span>
                            <select class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="formatTextSize(this.value)" title="K√≠ch th∆∞·ªõc ch·ªØ">
                                <option value="">K√≠ch th∆∞·ªõc</option>
                                <option value="8px">8px</option>
                                <option value="10px">10px</option>
                                <option value="12px">12px</option>
                                <option value="14px" selected>14px</option>
                                <option value="16px">16px</option>
                                <option value="18px">18px</option>
                                <option value="20px">20px</option>
                                <option value="24px">24px</option>
                                <option value="28px">28px</option>
                                <option value="32px">32px</option>
                            </select>
                            <span class="border-start mx-2"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('removeFormat')" title="X√≥a ƒë·ªãnh d·∫°ng">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        <div id="editor" contenteditable="true" class="form-control border rounded-bottom" 
                             style="min-height: 300px; padding: 15px; overflow-y: auto;"
                             onpaste="handlePaste(event)">{{ note.content | safe if note else '' }}</div>
                        <textarea id="content" name="content" style="display: none;"></textarea>
                        <small class="form-text text-muted">B·∫°n c√≥ th·ªÉ ƒë·ªãnh d·∫°ng text b·∫±ng c√°c c√¥ng c·ª• tr√™n ho·∫∑c ph√≠m t·∫Øt: Ctrl+B (ƒë·∫≠m), Ctrl+I (nghi√™ng)</small>
                    </div>
                    <div class="mb-3">
                        <label for="attachments" class="form-label">
                            <i class="bi bi-paperclip"></i> ƒê√≠nh k√®m file
                        </label>
                        <input type="file" class="form-control" id="attachments" name="attachments" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar">
                        <small class="form-text text-muted">C√≥ th·ªÉ ch·ªçn nhi·ªÅu file c√πng l√∫c (h√¨nh ·∫£nh, t√†i li·ªáu PDF, Word, Excel, v.v.)</small>
                        
                        <!-- Preview Area for Selected Files -->
                        <div id="filePreview" class="mt-3" style="display: none;">
                            <label class="form-label">Files ƒë√£ ch·ªçn:</label>
                            <div id="fileList" class="row g-2"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√†u n·ªÅn tab ghi ch√∫</label>
                        {% if note %}
                        <div class="d-flex flex-wrap gap-2" id="form-note-color" data-note-id="{{ note.id }}">
                            {% set colors = ['#ffffff', '#f5f5f5', '#fffbe6', '#e6f7ff', '#f6ffed', '#fff0f6', '#f0f5ff', '#f9f0ff', '#f0fff4'] %}
                            {% for c in colors %}
                            <button type="button" class="border note-form-color" data-color="{{ c }}" style="width:24px;height:24px;border-radius:4px;background: {{ c }};"></button>
                            {% endfor %}
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="clearFormNoteColor">
                                <i class="bi bi-eraser"></i> X√≥a m√†u
                            </button>
                        </div>
                        <small class="form-text text-muted">√Åp d·ª•ng cho th·∫ª ghi ch√∫ ·ªü danh s√°ch sau khi l∆∞u.</small>
                        {% else %}
                        <div class="text-muted">Ch·ªçn m√†u n·ªÅn c√≥ th·ªÉ th·ª±c hi·ªán sau khi t·∫°o (menu 3 ch·∫•m c·ªßa ghi ch√∫).</div>
                        {% endif %}
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('notes') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> H·ªßy
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> L∆∞u
                        </button>
                    </div>
                </form>

                {% if note and note.attachments %}
                <div class="mb-3 mt-3">
                    <label class="form-label">File ƒë√≠nh k√®m hi·ªán c√≥:</label>
                    <div class="list-group">
                        {% for attachment in note.attachments %}
                        {% set filename = attachment.get('filename', '') %}
                        {% set original_filename = attachment.get('original_filename', filename) %}
                        {% set is_image = filename.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp')) %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    {% if is_image %}
                                    <div class="mb-2">
                                        <img src="{{ url_for('download_attachment', note_id=note.id, filename=filename) }}"
                                             class="img-thumbnail"
                                             style="max-width: 200px; max-height: 150px; object-fit: cover;"
                                             alt="{{ original_filename }}">
                                    </div>
                                    {% endif %}
                                    <div>
                                        <i class="bi bi-file-earmark"></i>
                                        <a href="{{ url_for('download_attachment', note_id=note.id, filename=filename) }}" target="_blank">
                                            {{ original_filename }}
                                        </a>
                                        {% if is_image %}
                                        <span class="badge bg-info ms-2">H√¨nh ·∫£nh</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if current_user.role != 'viewer' %}
                                <form method="post" action="{{ url_for('delete_attachment', note_id=note.id, filename=filename) }}"
                                      onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a file n√†y?');" class="d-inline ms-2">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark bg-opacity-75 border-0" style="box-shadow:0 0 32px #000;">
      <div class="modal-header border-0" style="border-bottom:none;">
        <h5 class="modal-title text-white" id="imageModalLabel">Xem ·∫£nh l·ªõn</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
      </div>
      <div class="modal-body d-flex justify-content-center align-items-center" style="min-height:50vh;">
        <img id="modalImage" src="" style="max-width:90vw; max-height:80vh; border-radius:10px; background:white; box-shadow:0 0 40px 0 #000; object-fit:contain;" />
      </div>
    </div>
  </div>
</div>

