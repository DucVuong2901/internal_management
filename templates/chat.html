{% extends "base.html" %}

{% block title %}Chat Tổng - Hệ thống Quản lý Nội Bộ{% endblock %}

{% block extra_css %}
<style>
/* ==== Base & Layout ==== */
footer{display:none!important}
.chat-container{display:flex;background:#f8f9fa;transition:background-color .3s ease;height:100%;padding:20px}
.chat-main{flex:1;display:flex;flex-direction:column;background:white;overflow:hidden;transition:background-color .3s ease;height:100%;max-width:1200px;margin:0 auto;width:100%;border:2px solid #e0e0e0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
.chat-messages{flex:1;overflow-y:auto;overflow-x:hidden;padding:20px;background:#f8f9fa;transition:background-color .3s ease;height:0}
.message{display:flex;margin-bottom:16px;align-items:flex-start}
.message-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;flex-shrink:0;margin-right:12px}
.message-content{flex:1}
.message-header{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.message-username{font-weight:600;font-size:14px;color:#495057}
.message-time{font-size:11px;color:#6c757d}
.message-bubble{padding:10px 14px;border-radius:12px;background:#fff;color:#212529;box-shadow:0 1px 2px rgba(0,0,0,0.05);transition:background-color .3s ease,color .3s ease;word-wrap:break-word;white-space:pre-wrap}
.message.sent .message-avatar{background:linear-gradient(135deg,#28a745,#20c997)}
.message.sent .message-bubble{background:#e3f2fd}
.message-text{line-height:1.5;word-break:break-word}
.chat-header{border-top-left-radius:14px;border-top-right-radius:14px;border-bottom:2px solid #e0e0e0!important;background:#fff!important}
.chat-input-area{padding:20px;padding-bottom:25px;border-top:2px solid #e0e0e6;background:#fff;flex-shrink:0;z-index:10;transition:all .3s ease;border-bottom-left-radius:14px;border-bottom-right-radius:14px}
.chat-input-form{display:flex;gap:10px;align-items:flex-end}
.chat-input-wrapper{position:relative;flex:1}
#messageInput{min-height:48px;max-height:200px;overflow-y:auto;resize:none}
.attach-btn-inline{position:absolute;right:8px;bottom:8px;background:transparent;border:none;color:#6c757d;padding:6px 8px;cursor:pointer;border-radius:4px;transition:all .2s ease}
.attach-btn-inline:hover{background:#f8f9fa;color:#495057}
[data-theme="dark"] .attach-btn-inline{color:#adb5bd}
[data-theme="dark"] .attach-btn-inline:hover{background:#3a3a3a;color:#e9ecef}
.send-btn{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s ease}
.send-btn:hover{transform:scale(1.05)}

/* ==== Dark Mode ==== */
[data-theme="dark"] .chat-container{background:#1a1a1a}
[data-theme="dark"] .chat-main{background:#1a1a1a;border-color:#404040;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
[data-theme="dark"] .chat-messages{background:#1a1a1a}
[data-theme="dark"] .message-bubble{background:#3a3a3a;color:#e9ecef!important}
[data-theme="dark"] .message.sent .message-bubble{background:#2c5282;color:#e9ecef!important}
[data-theme="dark"] .message.received .message-bubble{color:#e9ecef!important}
[data-theme="dark"] .message-text{color:#e9ecef!important}
[data-theme="dark"] .chat-input-area{background:#2d2d2d;border-top-color:#404040}
[data-theme="dark"] .chat-header{background:#2d2d2d!important;border-bottom-color:#404040!important}
[data-theme="dark"] .message-username{color:#e9ecef}
[data-theme="dark"] .message-time{color:#adb5bd}
[data-theme="dark"] #messageInput{background:#3a3a3a;color:#e9ecef;border-color:#495057}
[data-theme="dark"] #messageInput::placeholder{color:#adb5bd}

/* ==== Loading Spinner ==== */
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.spin{animation:spin 1s linear infinite}

/* ==== Toast Animation ==== */
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}

</style>
{% endblock %}

{% block content %}
<div class="chat-container" style="position:fixed;top:56px;left:0;right:0;bottom:0;">
  <!-- Main chat -->
  <div class="chat-main d-flex flex-column">
    <div class="chat-header p-3 border-bottom d-flex align-items-center gap-2 flex-shrink-0">
      <div class="chat-header-avatar rounded-circle bg-primary text-white fw-bold d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
        <i class="bi bi-people-fill"></i>
      </div>
      <div class="chat-header-info flex-grow-1">
        <h6 class="mb-0"><i class="bi bi-chat-dots"></i> Chat Tổng</h6>
        <small class="text-muted">{{ total_users }} thành viên</small>
      </div>
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Tùy chọn">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" onclick="event.preventDefault();showImages()">
            <i class="bi bi-images text-primary"></i> Xem ảnh đã gửi
          </a></li>
          <li><a class="dropdown-item" href="#" onclick="event.preventDefault();showAttachments()">
            <i class="bi bi-paperclip text-info"></i> Xem file đính kèm
          </a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="event.preventDefault();clearChatHistory()">
            <i class="bi bi-trash"></i> Xóa lịch sử chat
          </a></li>
        </ul>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input-area">
      <form id="chatForm" class="chat-input-form" enctype="multipart/form-data">
        <div class="chat-input-wrapper flex-grow-1 position-relative">
          <textarea id="messageInput" name="message" class="form-control" placeholder="Nhập tin nhắn..." style="padding-right:45px;"></textarea>
          <button type="button" class="attach-btn-inline" onclick="fileInput.click()" title="Đính kèm file">
            <i class="bi bi-paperclip"></i>
          </button>
          <input type="file" id="fileInput" name="attachment" style="display:none;">
        </div>
        <button type="submit" class="send-btn"><i class="bi bi-send-fill"></i></button>
      </form>
      <div id="filePreview" class="mt-2" style="display:none;">
        <small class="text-muted"><i class="bi bi-paperclip"></i> <span id="fileName"></span>
          <button type="button" class="btn btn-sm btn-link text-danger" onclick="clearFile()">Xóa</button>
        </small>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Socket.IO client -->
<script src="/socket.io/socket.io.js"></script>
<script>
let refreshInterval=null,lastMessageCount=0;
let socket=null,socketReady=false;
let totalMessageCount=0,isLoadingMore=false,allMessagesLoaded=false;
let userColors={};

/* === Generate consistent color for each user === */
function getUserColor(userId){
  if(userColors[userId])return userColors[userId];
  
  // Generate color based on user ID
  const hue=(userId*137.508)%360; // Golden angle for good distribution
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  
  // Adjust for dark mode
  const saturation=isDark?70:65+((userId*50)%20); // Brighter in dark mode
  const lightness=isDark?60:45+((userId*30)%15); // Lighter in dark mode
  
  userColors[userId]=`hsl(${hue},${saturation}%,${lightness}%)`;
  return userColors[userId];
}

function getUserColorLight(userId){
  if(!userColors[userId])getUserColor(userId);
  const hue=(userId*137.508)%360;
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  
  // Adjust background for dark mode
  if(isDark){
    return `hsl(${hue},40%,25%)`; // Dark background with color tint
  }else{
    return `hsl(${hue},70%,95%)`; // Light background
  }
}

/* === Scroll === */
function scrollToBottom(force=false){
  const box=document.getElementById('chatMessages');
  if(!box)return;
  const nearBottom=box.scrollHeight-box.scrollTop-box.clientHeight<120;
  if(force||nearBottom) box.scrollTo({top:box.scrollHeight,behavior:'smooth'});
}

/* === Load messages === */
async function loadMessages(){
  try{
    const r=await fetch('/chat/group/messages');
    const d=await r.json();
    if(d.success){
      totalMessageCount=d.total_count||d.messages.length;
      allMessagesLoaded=!d.has_more;
      displayMessages(d.messages,true);
    }
  }catch(e){console.error(e);}
}

/* === Hiển thị tin nhắn === */
function displayMessages(msgs,forceScroll=false,prepend=false){
  const c=document.getElementById('chatMessages');
  const uid={{ current_user.id }};
  if(!prepend&&msgs.length===lastMessageCount&&!forceScroll)return;
  
  // Nếu prepend, lưu vị trí scroll hiện tại
  const oldScrollHeight=prepend?c.scrollHeight:0;
  
  if(!prepend)c.innerHTML='';
  msgs.forEach(m=>{
    const wrap=document.createElement('div');
    wrap.className=m.sender_id==uid?'message sent':'message received';
    
    // Avatar with user color
    const avatar=document.createElement('div');
    avatar.className='message-avatar';
    avatar.textContent=(m.sender_name||'?')[0].toUpperCase();
    if(m.sender_id!=uid){
      avatar.style.background=getUserColor(m.sender_id);
    }
    wrap.appendChild(avatar);
    
    // Content
    const content=document.createElement('div');
    content.className='message-content';
    
    // Header (username + time)
    const header=document.createElement('div');
    header.className='message-header';
    const username=document.createElement('span');
    username.className='message-username';
    username.textContent=m.sender_name||'Unknown';
    const time=document.createElement('span');
    time.className='message-time';
    time.textContent=formatTime(m.created_at);
    header.appendChild(username);
    header.appendChild(time);
    content.appendChild(header);
    
    // Bubble with user color
    const b=document.createElement('div');
    b.className='message-bubble';
    if(m.sender_id!=uid){
      b.style.backgroundColor=getUserColorLight(m.sender_id);
      b.style.borderLeft=`3px solid ${getUserColor(m.sender_id)}`;
    }
    if(m.message){b.innerHTML+=`<div class='message-text'>${escapeHtml(m.message)}</div>`;}
    if(m.attachment_filename){
      const ext=m.attachment_filename.toLowerCase();
      const isImg=/\.(jpg|jpeg|png|gif|webp|bmp)$/.test(ext);
      if(isImg){
        b.innerHTML+=`<div class="message-image-preview mt-2"><img src="/chat/download/${m.attachment_filename}" style="max-width:300px;cursor:pointer;border-radius:8px" ondblclick="showImagePopup('/chat/download/${m.attachment_filename}','${m.attachment_original_name||m.attachment_filename}')"></div>`;
      }else{
        b.innerHTML+=`<div class="message-attachment mt-2"><i class="bi bi-file-earmark"></i> <a href="/chat/download/${m.attachment_filename}" download>${m.attachment_original_name||m.attachment_filename}</a></div>`;
      }
    }
    content.appendChild(b);
    wrap.appendChild(content);
    if(prepend){
      c.insertBefore(wrap,c.firstChild);
    }else{
      c.appendChild(wrap);
    }
  });
  if(!prepend)lastMessageCount=msgs.length;
  
  // Nếu prepend, giữ vị trí scroll
  if(prepend){
    const newScrollHeight=c.scrollHeight;
    c.scrollTop=newScrollHeight-oldScrollHeight;
  }else{
    scrollToBottom(forceScroll);
  }
}

function escapeHtml(text){
  const div=document.createElement('div');
  div.textContent=text;
  return div.innerHTML.replace(/\n/g,'<br>');
}

/* === Polling fallback === */
function startPolling(){
  if(refreshInterval)clearInterval(refreshInterval);
  refreshInterval=setInterval(refreshMessages,3000);
}
function stopPolling(){
  if(refreshInterval){clearInterval(refreshInterval);refreshInterval=null;}
}
async function refreshMessages(){
  try{
    const r=await fetch('/chat/group/messages');
    const d=await r.json();
    if(d.success){
      totalMessageCount=d.total_count||d.messages.length;
      displayMessages(d.messages);
    }
  }catch(e){console.error(e);}
}

/* === Load more messages (lazy loading) === */
async function loadMoreMessages(){
  if(isLoadingMore||allMessagesLoaded)return;
  
  const c=document.getElementById('chatMessages');
  const currentCount=c.querySelectorAll('.message').length;
  
  if(currentCount>=totalMessageCount){
    allMessagesLoaded=true;
    return;
  }
  
  isLoadingMore=true;
  
  // Hiển thị loading indicator
  const loader=document.createElement('div');
  loader.id='loadingMore';
  loader.className='text-center py-2';
  loader.innerHTML='<small class="text-muted"><i class="bi bi-arrow-clockwise spin"></i> Đang tải...</small>';
  c.insertBefore(loader,c.firstChild);
  
  try{
    // Load 50 tin nhắn cũ hơn
    const r=await fetch(`/chat/group/messages?limit=50&offset=${currentCount}`);
    const d=await r.json();
    
    if(d.success&&d.messages.length>0){
      // Xóa loader
      loader.remove();
      
      // Thêm messages vào đầu
      displayMessages(d.messages,false,true);
      
      // Cập nhật trạng thái
      allMessagesLoaded=!d.has_more;
    }else{
      loader.remove();
      allMessagesLoaded=true;
    }
  }catch(e){
    console.error(e);
    loader.remove();
  }
  
  isLoadingMore=false;
}

/* === Detect scroll to top === */
function setupScrollListener(){
  const c=document.getElementById('chatMessages');
  c.addEventListener('scroll',()=>{
    // Nếu scroll gần đầu (trong 100px), load thêm
    if(c.scrollTop<100&&!isLoadingMore&&!allMessagesLoaded){
      loadMoreMessages();
    }
  });
}

/* === Gửi tin === */
chatForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const fd=new FormData(chatForm);
  if(!fd.get('message')&&!fd.get('attachment').name)return;
  const r=await fetch('/chat/group/send',{method:'POST',body:fd});
  const d=await r.json();
  if(d.success){chatForm.reset();clearFile();messageInput.style.height='auto';lastMessageCount=0;await refreshMessages();scrollToBottom(true);}
  else{alert('Lỗi: '+(d.error||'Không thể gửi tin nhắn'));}
});

/* === Auto-resize textarea === */
function autoResizeTextarea(){
  messageInput.style.height='auto';
  messageInput.style.height=Math.min(messageInput.scrollHeight,200)+'px';
}
messageInput.addEventListener('input',autoResizeTextarea);

/* === Enter để gửi === */
messageInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    chatForm.dispatchEvent(new Event('submit'));
  }
});

/* === File preview === */
fileInput.addEventListener('change',()=>{if(fileInput.files.length)showFilePreview(fileInput.files[0]);});
function clearFile(){fileInput.value='';filePreview.style.display='none';}
function showFilePreview(f){fileName.textContent=f.name;filePreview.style.display='block';}

/* === Format thời gian === */
function formatTime(iso){
  const d=new Date(iso);
  const diff=Date.now()-d.getTime();
  
  // < 1 phút
  if(diff<60000)return'Vừa xong';
  // < 1 giờ
  if(diff<3600000)return Math.floor(diff/60000)+'p';
  // < 24 giờ
  if(diff<86400000)return Math.floor(diff/3600000)+'h';
  
  // >= 24 giờ: hiển thị ngày tháng giờ
  const today=new Date();
  const yesterday=new Date(today);
  yesterday.setDate(yesterday.getDate()-1);
  
  const isYesterday=d.toDateString()===yesterday.toDateString();
  const time=d.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
  
  if(isYesterday)return'Hôm qua '+time;
  return d.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'})+' '+time;
}


/* === Paste & DragDrop === */
function setupPasteHandler(){
  // Paste handler for both textarea and chat area
  const handlePaste=e=>{
    const items=e.clipboardData?.items||[];
    for(const it of items){
      if(it.type.includes('image')){
        e.preventDefault();
        const blob=it.getAsFile();
        const dt=new DataTransfer();
        dt.items.add(new File([blob],`pasted-${Date.now()}.png`,{type:blob.type}));
        fileInput.files=dt.files;
        showFilePreview(dt.files[0]);
        messageInput.focus();
        
        // Show notification
        const toast=document.createElement('div');
        toast.style.cssText='position:fixed;top:80px;right:20px;background:#28a745;color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;animation:slideIn 0.3s ease';
        toast.innerHTML='<i class="bi bi-check-circle"></i> Đã dán ảnh từ clipboard';
        document.body.appendChild(toast);
        setTimeout(()=>toast.remove(),2000);
        break;
      }
    }
  };
  
  messageInput.addEventListener('paste',handlePaste);
  chatMessages.addEventListener('paste',handlePaste);
  
  // Also handle Ctrl+V globally when chat is focused
  document.addEventListener('paste',e=>{
    if(document.activeElement===messageInput||e.target.closest('#chatMessages')){
      handlePaste(e);
    }
  });
}
function setupDragDropHandler(){[chatMessages,messageInput].forEach(z=>{
  ['dragenter','dragover','dragleave','drop'].forEach(ev=>z.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();}));
  z.addEventListener('drop',e=>{const f=e.dataTransfer.files;if(f.length){fileInput.files=f;showFilePreview(f[0]);messageInput.focus();}});
});}

/* === Xem file đính kèm === */
async function showAttachments(){
  const r=await fetch('/chat/group/messages');
  const d=await r.json();
  if(!d.success)return alert('Không thể tải file');
  const files=d.messages.filter(m=>m.attachment_filename&&!/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(m.attachment_filename));
  if(!files.length)return alert('Không có file đính kèm');
  
  const modal=document.createElement('div');
  modal.className='modal fade show d-block';
  modal.style.backgroundColor='rgba(0,0,0,0.5)';
  modal.innerHTML=`
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-paperclip"></i> File đính kèm (${files.length})</h5>
          <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
        </div>
        <div class="modal-body">
          <div class="list-group">
            ${files.map(f=>`
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <i class="bi bi-file-earmark"></i>
                  <a href="/chat/download/${f.attachment_filename}" download class="ms-2">${f.attachment_original_name||f.attachment_filename}</a>
                  <br><small class="text-muted">${formatTime(f.created_at)}</small>
                </div>
                <a href="/chat/download/${f.attachment_filename}" class="btn btn-sm btn-primary" download>
                  <i class="bi bi-download"></i>
                </a>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

/* === Xem ảnh đã gửi === */
async function showImages(){
  const r=await fetch('/chat/group/messages');
  const d=await r.json();
  if(!d.success)return alert('Không thể tải ảnh');
  const imgs=d.messages.filter(m=>m.attachment_filename&&/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(m.attachment_filename));
  if(!imgs.length)return alert('Không có ảnh');
  
  const modal=document.createElement('div');
  modal.className='modal fade show d-block';
  modal.style.backgroundColor='rgba(0,0,0,0.5)';
  modal.innerHTML=`
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-images"></i> Ảnh đã gửi (${imgs.length})</h5>
          <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            ${imgs.map(img=>`
              <div class="col-md-4 col-sm-6">
                <div class="card">
                  <img src="/chat/download/${img.attachment_filename}" class="card-img-top" style="height:200px;object-fit:cover;cursor:pointer" onclick="showImagePopup('/chat/download/${img.attachment_filename}','${img.attachment_original_name||img.attachment_filename}')">
                  <div class="card-body p-2">
                    <small class="text-muted">${formatTime(img.created_at)}</small>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}


/* === Xóa lịch sử chat === */
async function clearChatHistory(){
  if(!confirm('Xóa toàn bộ lịch sử chat?\n\nHành động này không thể hoàn tác!\n\nTất cả tin nhắn và file đính kèm sẽ bị xóa vĩnh viễn.')){
    return;
  }
  try{
    const r=await fetch('/chat/group/clear-history',{method:'POST'});
    const d=await r.json();
    if(d.success){
      alert('✓ Đã xóa lịch sử chat!');
      lastMessageCount=0;
      document.getElementById('chatMessages').innerHTML='';
      loadMessages();
    }else{
      alert('✗ Lỗi: '+(d.error||'Không thể xóa lịch sử'));
    }
  }catch(e){
    alert('✗ Lỗi kết nối: '+e.message);
  }
}

/* === Popup xem ảnh fullscreen === */
function showImagePopup(url,name){
  const m=document.createElement('div');
  m.className='position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
  m.style.cssText='background:rgba(0,0,0,0.9);z-index:9999;cursor:pointer';
  m.innerHTML=`
    <div class="text-center">
      <img src="${url}" alt="${name}" style="max-width:95vw;max-height:95vh;border-radius:8px;box-shadow:0 0 30px rgba(0,0,0,0.5)">
      <div class="mt-3 text-white"><small>${name}</small></div>
    </div>
  `;
  m.onclick=()=>m.remove();
  document.body.appendChild(m);
}

/* === Socket.IO realtime === */
function initSocket(){
  try{
    socket=io({transports:['websocket','polling']});
    socket.on('connect',()=>{socketReady=true;stopPolling();});
    socket.on('socket_ready',()=>{socketReady=true;stopPolling();});
    socket.on('disconnect',()=>{socketReady=false;startPolling();});
    socket.on('new_message',()=>{
      lastMessageCount=0;
      refreshMessages().then(()=>scrollToBottom(true));
    });
    socket.on('chat_cleared',()=>{
      lastMessageCount=0;
      document.getElementById('chatMessages').innerHTML='';
      alert('⚠️ Lịch sử chat đã bị xóa bởi admin');
    });
  }catch(e){console.error('Socket init failed',e);socketReady=false;startPolling();}
}

/* === Theme change listener === */
function setupThemeListener(){
  // Watch for theme changes
  const observer=new MutationObserver(()=>{
    // Clear color cache when theme changes
    userColors={};
    // Reload messages to apply new colors
    refreshMessages();
  });
  observer.observe(document.documentElement,{
    attributes:true,
    attributeFilter:['data-theme']
  });
}

/* === Init === */
document.addEventListener('DOMContentLoaded',()=>{
  setupPasteHandler();
  setupDragDropHandler();
  setupScrollListener();
  setupThemeListener();
  initSocket();
  loadMessages();
  setTimeout(()=>{if(!socketReady)startPolling();},1500);
});
</script>
{% endblock %}
